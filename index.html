<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>???</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/css/uikit.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.0/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.11/dist/js/uikit-icons.min.js"></script> 
    
    <link id="favicon" rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/5422/5422573.png" />

    <script src="config.js"></script>
    <script src="main.js"></script>
    
    <style>
        /* Override semua class UIkit text* agar mengikuti warna Bootstrap */
        [class*="uk-text"] {
            color: inherit !important; /* Default mengikuti Bootstrap */
        }

        /* Mapping warna Bootstrap */
        .uk-text-primary    { color: var(--bs-primary) !important; }
        .uk-text-secondary  { color: var(--bs-secondary) !important; }
        .uk-text-success    { color: var(--bs-success) !important; }
        .uk-text-danger     { color: var(--bs-danger) !important; }
        .uk-text-warning    { color: var(--bs-warning) !important; }
        .uk-text-info       { color: var(--bs-info) !important; }
        .uk-text-light      { color: var(--bs-light) !important; }

        /* Kalau Bootstrap < 5, bisa pakai kode warna manual */
        :root {
            --bs-primary:   #0d6efd;
            --bs-secondary: #000204;
            --bs-success:   #05a705;
            --bs-danger:    #ea0c0c;
            --bs-warning:   #f68f02;
            --bs-info:      #0dcaf0;
            --bs-light:     #f8f9fa;
        }

        .uk-container {  max-width: none; }        
        .status-active { color: green; }
        .status-inactive { color: red; }
        .sort-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); }
        /* Memaksa warna link untuk CEX */
        .uk-link {
            color: inherit !important;  /* Memastikan warna link mengikuti warna induk */
        }
        a {
            text-decoration: none; /* Menghapus garis bawah */
            color: inherit;        /* Menggunakan warna teks elemen induk */
        }
        /* Memaksa warna status aktif */
        .status-active {
            color: inherit !important;  /* Warna aktif mengikuti warna yang ditentukan */
        }
        img:hover {
                opacity:1;
                transform: scale(1.8); /* You can adjust the scale factor as needed */
            }
        img{
            margin: 1.5px;
        }    
        #progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 10px;
            margin-top: 10px;  /* Ubah margin top menjadi lebih kecil */
        }

        #progress-bar {
            height: 14px;  /* Mengurangi tinggi bar progress menjadi 10px */
            width: 0%;
            /* background-color: #157515; */
            border-radius: 5px; /* Untuk membuat ujung bar lebih melengkung */
            position: relative;
        }

        #progress-bar span {
            color: white;
            text-align: center;
            line-height: 10px;  /* Menyesuaikan tinggi bar agar teks tetap berada di tengah */
            display: block;
            font-weight: bold;
        }

        /* Tambahkan scroll untuk tabel */
        .uk-overflow-auto {
            overflow-x: auto; /* Scroll horizontal jika diperlukan */
            max-height: 800px; /* Batasi tinggi untuk memunculkan scroll */
            background-color: white; 
        }

        .uk-table tbody td {
            font-size: 12px;
            border: 0.85px solid #121010;
            padding: 4px;
            white-space: nowrap;
        }
        .uk-background{
            background-color: #e2e2e2 !important;
        }
       
        .merah{
            font-weight: bold;
            color: rgb(250, 249, 249) !important;
            background-color:#eb6464!important;
        }
        .buy {
            color:#05a705;
        }
        .sell {
            color:#ea0c0c;
        }
        .ijo {
            color: black !important;
            font-weight: bolder;
        }
        .error{
            color: #fafafa!important;
            background-color: #ffe0e6!important;
        }
        .errorrestapi{
            background-color: #f6f2f1!important;
        }
       
        .sinyal-item {
            margin-bottom: 2px;  /* Jarak antar sinyal */
            padding-bottom: 1px;  /* Jarak dari garis bawah ke teks */
            border-bottom: 1px solid #ccc;  /* Garis bawah sebagai pembatas */
        }
        body{
            font-family: Arial, Helvetica, sans-serif;
            padding: 1px;
            /* background-image: linear-gradient(#cffad4, #fefefe, #f3f7f4); */
            color: #0f0f0f;
        }
        .icon-wrapper {
            margin: 4px;
            display: inline-flex;          /* Menjadikan elemen inline fleksibel */
            justify-content: center;       /* Pusatkan gambar secara horizontal */
            align-items: center;           /* Pusatkan gambar secara vertikal */
            transform: scale(1.8);              /* Tinggi ikon */
            background-color: #f04545;     /* Warna latar belakang */
            border-radius: 35%;            /* Membuat bentuk lingkaran */
            cursor: pointer;               /* Ubah kursor menjadi tangan saat diklik */
            transition: background-color 0.3s ease; /* Animasi untuk efek hover */
        }
        
        /* Warna link default (light mode) */
        a, .uk-link {
            color: inherit !important;
            text-decoration: none;
        }

        /* Warna link dalam dark mode */
        .dark-mode a,
        .dark-mode .uk-link {
            color: #4fc3f7 !important;  /* Warna biru muda, bisa diganti sesuai preferensi */
        }
        
        .dark-mode .uk-background {
            background-color: #797a7af5 !important;
        }

        body.dark-mode .uk-background-a {
            background-color: #6d6e6df5 !important;
        }

        /* Mode terang (default) */
        #sinyal-container {
           color: #000 !important;
            margin-top: 10px;
        }
        /* CSS dark mode */
        body {
            transition: background-color 0.3s, color 0.3s;
        }

        .dark-mode {
            background-color: #121212 !important;
            color: #5d0404 !important
        }

        .dark-mode .uk-table tbody td {
            background-color: #1e1e1e ;
            color: #f0f0f0 !important;
            border-color: #444 !important;
        }

        .dark-mode .uk-overflow-auto {
            background-color: #1a1a1a !important;
        }

        .dark-mode .uk-button {
            background-color: #333 !important;
            color: #fff !important;
            border-color: #555 !important;
        }

        .dark-mode .icon-wrapper {
            background-color: #333 !important;
        }

        .dark-mode .merah {
            background-color: #b00020 !important;
            color: #fff !important;
        }

        .dark-mode .buy {
            color:#20be20 !important
        }

        .dark-mode .sell {
            color: #ff6666 !important;
        } 

        .hover-link {
            text-decoration: underline dotted;
            cursor: help;
        }

       .hover-link:hover {
            cursor: pointer;
            color: rgb(182, 182, 243);
            text-decoration: underline;
        }
    
        .toggle-radio.active {
            background-color: #1e87f0; /* uk-primary */
            color: #fff;
            font-weight: bold;
        }
       .uk-icon {
            /* width: 24px;
            height: 24px; */
            vertical-align: middle;
            stroke-width: 1.2;    
            stroke: black;
        }

        .icon:hover {
            transform: scale(1.6); /* membesarkan 30% */
        }

        .header-card {
            padding: 6px 12px !important; /* lebih kecil agar rapat */
            border: 1px solid black;
        }

        .header-card h3 {
            font-size: 18px;
            line-height: 1.2;
            margin: 0;
            color: #000;
            font-weight: bold;
        }

        /* Flex baris kedua (info + konfigurasi) */
        .info-config-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap; /* biar responsif */
        }

        .info-left,
        .info-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .uk-container {
            max-width: 100% !important;
            padding-left: 8px;
            padding-right: 8px;
        }

        .uk-card,
        .uk-card-default {
            border-radius: 5px; /* bisa diganti 8px/16px sesuai selera */
            overflow: hidden;    /* biar konten ikut rounded */
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); /* optional, biar soft */
        }

        .uk-card img,
        .uk-card-default img {
            border-radius: 5px 5px 0 0; /* gambar di atas ikut rounded */
        }

        /* Baris ganjil */
        .uk-table tbody tr:nth-child(odd) {
            background-color: #f7f7f7 !important; /* warna abu muda */
        }

        /* Baris genap */
        .uk-table tbody tr:nth-child(even) {
            background-color: #ececec !important; /* abu sedikit lebih gelap */
        }

        /* Opsional: hover effect */
        .uk-table tbody tr:hover {
            background-color: #f8f2d0 !important; /* abu hover */
        }
        #progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden; /* biar ujung bar tetap rapi saat animasi */
        }

        #progress-bar {
            height: 14px;
            width: 0%;
            border-radius: 5px;
            position: relative;

            /* Warna dasar + pola strip diagonal */
            background-color: #5c9513;
            background-image: repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.3) 0,
                rgba(255, 255, 255, 0.3) 10px,
                transparent 10px,
                transparent 20px
            );
            background-size: 20px 20px;

            /* Animasi strip bergerak */
            animation: move-stripes 1s linear infinite;
        }

        #progress-bar span {
            color: white;
            text-align: center;
            line-height: 14px;
            display: block;
            font-weight: bold;
        } 

    </style>
    <!-- <base href="/V1/"> -->
    </head>
    <body>

    <div class="uk-container uk-margin-small-top uk-background-a">
        <!-- Card Bagian Header -->
        <div class="uk-card uk-card-default uk-margin-small header-card">
            <div class="uk-grid-small uk-flex-middle" uk-grid>
                    
                    <!-- Kiri: Judul -->
                    <div class="uk-width-expand@s uk-width-1-1">
                        <div class="uk-flex uk-flex-middle uk-flex-wrap">
                            <h3 id="judul" class="uk-margin-remove" 
                                style="font-size: 18px; line-height: 1.2; color: #000; font-weight: bold;">
                                MULTIALL [GLOBAL] :: <label id="namachain"></label> 
                                <img src="https://coopsugar.org/storage/2022/03/new.gif" width="24px" />
                            </h3>
                            <span class="uk-margin-small-left">[ &nbsp;<b> 
                                <span class="uk-text-danger uk-text-small" id="infoAPP">???</span> 
                            </b>&nbsp; ]</span>
                        </div>
                    </div>

                    <!-- Kanan: Toolbar icon -->
                    <div class="uk-width-auto@s uk-width-1-1">
                        <div class="uk-flex uk-flex-middle uk-flex-wrap uk-flex-right@s" style="gap: 6px;">
                            <a href="sniper.html"><img class="icon" title="MULTIALL [SNIPER]" width="22px"
                                src="https://cdn-icons-png.flaticon.com/512/30/30279.png" target="_blank" /></a>
                             <span id="chain-links-container"></span>
                            <img class="icon" id="reload" title="RESET PROSES" width="24px"
                                src="https://cdn-icons-png.flaticon.com/512/3580/3580284.png" />
                            <img class="icon" id="LoadDataBtn" title="LOAD DATA TOKEN" width="24px"
                                src="https://png.pngtree.com/png-clipart/20230815/original/pngtree-database-sync-icon-icon-symbol-data-vector-picture-image_10830033.png" />
                            <img class="icon" id="SettingModal" title="CONFIG SCANNER" width="24px"
                                src="https://cdn-icons-png.flaticon.com/512/1170/1170635.png" />
                            <img class="icon" id="UpdateWalletCEX" title="UPDATE WALLET CEX" width="24px"
                                src="https://images.freeimages.com/fic/images/icons/2770/ios_7_icons/512/wallet.png" />
                            <a href="modal.html" target="_blank"><img class="icon" title="MANAJEMEN ASSET" width="24px"
                                src="https://cdn-icons-png.flaticon.com/512/1194/1194711.png" /></a>
                            <a href="multipair.html" target="_blank"><img class="icon" title="SETTING DATA" width="24px"
                                src="https://cdn-icons-png.flaticon.com/128/3934/3934107.png" /></a>
                            <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank"><img class="icon" title="BUKA AKSES" width="24px"
                                src="https://cdn-icons-png.flaticon.com/512/9921/9921748.png" /></a>
                            
                            <a href="#" class="icon" onclick="downloadTokenScannerJSON()" title="EXPORT KOIN">
                                <img src="https://cdn-icons-png.flaticon.com/512/157/157921.png" width="24px" />
                            </a>
                            <label for="uploadJSON" title="IMPORT KOIN" style="cursor:pointer;">
                                <img src="https://cdn-icons-png.flaticon.com/512/219/219431.png" width="24px" />
                            </label>
                            <input type="file" id="uploadJSON" accept="application/json" style="display:none;" onchange="uploadTokenScannerJSON(event)">
                            <img class="icon" id="darkModeToggle" title="Ganti Mode Gelap/Terang" width="24px"
                                src="https://cdn-icons-png.flaticon.com/512/3751/3751403.png" onclick="toggleDarkMode()" /> 
                        </div>
                    </div>

            </div>
        </div>

        <!-- Card Bagian Info & Konfigurasi Scanner -->
        <div class="uk-card uk-card-default uk-padding-small uk-card-hover" style="border: 1px solid;padding-top: 6px;padding-bottom: 6px;" id="scanner-config">
            <div class="uk-grid-small uk-flex-middle" uk-grid>

                <!-- Form Setting responsif -->
                <div class="uk-width-1-1">
                    <form id="cryptoForm" class="uk-flex uk-flex-middle uk-flex-wrap" style="gap: 8px;">
                        <div id="cex-options" class="uk-flex uk-flex-middle"></div> &nbsp;|&nbsp;
                        <div id="dex-options" class="uk-flex uk-flex-middle"></div>&nbsp;|&nbsp;
                        <b><span class="uk-text-secondary">PAIR:</span></b>
                        <span id="tokenCount" class="uk-text-danger uk-text-bolder"></span>
                        <div id="dexpair-options" class="uk-flex uk-flex-middle"></div>&nbsp;|&nbsp;
                        <span class="uk-text-secondary uk-text-bolder">SCANNER:</span>
                        <label><input class="uk-checkbox posisi-check" type="checkbox" value="Actionkiri" checked> <span class="uk-text-success uk-form-label">KIRI</span></label>
                        <label><input class="uk-checkbox posisi-check" type="checkbox" value="ActionKanan" checked> <span class="uk-text-success uk-form-label">KANAN</span></label>
                        <label><input class="uk-checkbox" id="strictFilter" type="checkbox" checked> <span class="uk-text-primary uk-form-label">WALLET CEX</span></label>
                        <label><input class="uk-checkbox vol-check" id="checkVOL" type="checkbox"> <span class="uk-text-danger uk-form-label">VOL CHECK</span></label>
                        <div class="uk-button-group">
                            <label class="uk-button uk-button-small uk-button-default toggle-radio sort-toggle active" data-sort="opt_A">
                                <input class="uk-hidden" type="radio" name="toggle" value="opt_A" checked> A-Z
                            </label>
                            <label class="uk-button uk-button-small uk-button-default toggle-radio sort-toggle" data-sort="opt_B">
                                <input class="uk-hidden" type="radio" name="toggle" value="opt_B"> Z-A
                            </label>
                        </div>
                        <div class="uk-button-group">
                            <button type="button" id="startSCAN" class="uk-button uk-button-secondary uk-button-small">START</button>
                            <button type="button" id="stopSCAN" class="uk-button uk-button-danger uk-button-small">STOP</button>
                        </div>
                    </form>


                    <div id="progress-container" style="width: 100%; background-color: #f3f3f3; border-radius: 10px; margin-top: 10px;">
                        <div id="progress-bar" style="height: 14px; width: 0%; background-color: #4caf50; border-radius: 5px;">
                            <span id="progress-text" style="color: rgb(7, 102, 8); font-size: 11px; text-align: center; line-height: 10px; display: block; font-weight: bold;">0%</span>
                        </div>
                    </div>
                    <div id="progress" style="font-size: 13px; font-weight: bold; margin-top: 5px; color:#157515;"></div>
                </div>

            </div>
        </div>

<!--  modal add multiall -->
<div id="multiscanModal" uk-modal>
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">

    <!-- Header -->
    <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
      <h4 class="uk-modal-title uk-margin-remove uk-width-expand">Import Koin [SNIPER]</h4>
      <button class="uk-modal-close-default" type="button" uk-close></button>
    </div>
    <hr class="uk-margin-remove-top uk-margin-small-bottom">

    <hr class="uk-margin-remove-top uk-margin-small-bottom"> <!-- Info Token --> <div id="multiTokenInfo" class="uk-card uk-card-default uk-card-small uk-card-body uk-margin-small-bottom"> <div class="uk-grid-small uk-child-width-1-1" uk-grid> <div> <b>Nama Token [Desimal] :</b> <span id="infoSymbolToken"></span> [<span id="infoDesToken"></span>] </div> <div> <b>Smart Contract :</b> <span id="infoSCToken"></span> </div> </div> </div> <!-- Info Pair --> <div id="multiPairInfo" class="uk-card uk-card-default uk-card-small uk-card-body uk-margin-small-bottom"> <div class="uk-grid-small uk-child-width-1-1" uk-grid> <div> <b>Nama Pair [Desimal] :</b> <span id="infoSymbolPair"></span> [<span id="infoDesPair"></span>] </div> <div> <b>Smart Contract :</b> <span id="infoSCPair"></span> </div> </div> </div>

    <!-- Form -->
    <form id="multiTokenForm" class="uk-form-stacked">
      <div class="uk-card uk-card-default uk-card-small uk-card-body uk-margin-small">
        <!-- Modal global kiri/kanan -->
        <div class="uk-grid-small" uk-grid>
          <div class="uk-width-1-2@m">
            <label class="uk-form-label uk-text-bold">Exchanger & Modal (CEX ➜ DEX)</label>
            <div class="uk-form-controls">
              <input id="modalCEX" class="uk-input" type="number" min="0" step="0.0001" placeholder="Contoh: 100" value="100">
            </div>
            <div id="cex-checkbox-group" class="uk-margin-small-top"></div>
          </div>
          <div class="uk-width-1-2@m">
            <label class="uk-form-label uk-text-bold">DEX & Modal (DEX ➜ CEX)</label>
            <div class="uk-form-controls">
              <input id="modalDEX" class="uk-input" type="number" min="0" step="0.0001" placeholder="Contoh: 100" value="100">
              <div class="uk-flex uk-flex-between uk-flex-middle">
            </div>
            <div id="dex-checkbox-group" class="uk-margin-small-top"></div>
            </div>
          </div>
        </div>
        <input type="hidden" id="multiTokenIndex">
      </div>

      <!-- Actions -->
      <div class="uk-flex uk-flex-right uk-margin-top">
        <button class="uk-button uk-button-default uk-modal-close" type="button" id="batalimportkoin">Batal</button>
        <button class="uk-button uk-button-primary" type="submit" id="importkoin">Import</button>
      </div>
    </form>

  </div>
</div>

        <!-- Modal SETTING APLIKASI -->
        <div id="modal-setting" class="uk-modal-full" uk-modal>
            <div class="uk-modal-dialog">
                <button class="uk-modal-close-full uk-close-large" type="button" uk-close></button>
                <div class="uk-modal-header">
                    <h2 class="uk-modal-title">:: SETTING MODAL & SCANNER</h2>
                
                </div>
                <div class="uk-modal-body">
                    <form> 
                        <!-- Grid UIkit untuk 2 kolom -->
                        <div class="uk-grid-small" uk-grid>
                            
                            <div class="uk-width-1-2">
                                
                                <!-- Kolom pertama -->
                                <div class="uk-card uk-card-default uk-card-body">
                                    <div id="modal-container"></div>                                
                                </div>

                            </div>
                            <div class="uk-width-1-2">
                                <!-- Kolom kedua -->
                                <div class="uk-card uk-card-default uk-card-body">
                                    <h3 style="text-align: center; margin: 12px 0px; color: #1317e1;">:: SETINGAN SCANNER</h3>
                                    <label for="pnl">NICK NAME:</label>
                                    <input type="text" id="user"  class="uk-input" required>

                                    <div class="uk-flex uk-flex-middle uk-margin ">
                                        <!-- <div style="display: none;"> -->
                                        <div>
                                            <label for="jeda-time-group" class="uk-text-danger">KOIN/GRUP : </label>
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="7" name="koin-group"> 7</label>                                          
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="6"  name="koin-group"> 6</label> 
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="5" checked name="koin-group"> 5</label>
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="4"  name="koin-group"> 4</label>  
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="3"  name="koin-group"> 3</label>  
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="2"  name="koin-group"> 2</label>  
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="1"  name="koin-group"> 1</label>  
                                        </div>
                                        </div>
                                    <div class="uk-flex uk-flex-middle uk-margin ">
                                        <div>
                                                <label for="SPEEDSCAN" class="uk-text-danger">WAKTU TUNGGU</label>
                                                <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="2"  name="waktu-tunggu"> NORMAL </label>
                                                <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="1.5" name="waktu-tunggu"> MEDIUM </label>
                                                <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="1" name="waktu-tunggu"> FAST </label>
                                            </div>
                                    </div>
                                    <div>
                                    </div>
                                    
                                    <div class="uk-flex uk-flex-middle uk-margin ">
                                    <!-- <div style="display: none;"> -->
                                        <div>
                                            <label for="jeda-koin" class="uk-text-warning">FILTER PNL</label><br/>
                                            <input class="uk-input" type="number" id="inFilterPNL" value="0" name="filterpnl" >         
                                        </div>
                                        <div>
                                            <label for="jeda-time-group" class="uk-text-danger">JEDA / GROUP {500}</label><br/>
                                            <input class="uk-input" id="jeda-time-group" type="number" value="500" name="jeda-time-group" >
                                        </div>
                                        <div>
                                            <label for="jeda-koin" class="uk-text-primary">JEDA / KOIN {500}</label><br/>
                                            <input class="uk-input" type="number" id="jeda-koin" value="500" name="jeda-koin" > 
                                        </div>
                                    </div>

                                        <div>
                                            <label for="walletMeta" class="uk-text-danger">WALLET ADDRESS</label><br />
                                            <input class="uk-input" type="text" id="walletMeta" name="walletMeta" >
                                        </div>
                                    <div>                          
                                                
                                    </div>
                                    
                                    <p class="uk-text-right">
                                        <button class="uk-button uk-button-default uk-modal-close" type="button">Tutup</button>
                                        <button type="button" id="save-config" class="uk-button uk-button-primary" >SIMPAN</button>  
                                    </p>   
                                </div>
                            </div>
                        </div>
                
                    </form>
                </div>
            </div>
        </div>

        <!-- HEADER TABEL DAN INFO SINYAL PER DEX -->
        <div>
            <!-- Bagian untuk menampilkan sinyal DEX -->
            <div  id="sinyal-container">
                <!-- Sinyal DEX akan dimuat di sini -->
            </div>
            <div class="uk-grid-small uk-flex uk-flex-middle  uk-margin-small-top" uk-grid>
                <!-- Judul dan Jumlah Token -->
                <div class="uk-width-expand">
                    <h4 class="uk-heading-line uk-margin-remove" id="daftar">
                        <span style="font-size:medium; font-weight: bolder;">DAFTAR TOKEN PAIR ::  <span id="namachain2"></span> (<span id="tokenCountALL" class="token-count">0</span>)</span>
                    </h4>           
                </div>
            
                
                <!-- Pencarian -->
                <div class="uk-width-auto uk-flex uk-flex-middle">
                    <input class="form-check-input me-1" type="checkbox" id="autoScrollCheckbox">
                    <label class="form-check-label uk-text-warning" for="autoScrollCheckbox">Auto Scroll</label>

                    &nbsp;&nbsp;&nbsp;
                    <input type="text" id="searchInput" class="uk-input uk-form-small uk-form-primary uk-form-width-small" placeholder="Cari di tabel...">
                </div>
            </div>
        </div>

        
        <div class="uk-overflow-auto uk-margin-small-top">
            <table class="uk-table uk-table-hover uk-table-small uk-table-striped">
                <thead class="table-header">
                    <tr>
                        <!-- Kolom-kolom header akan ditambahkan secara dinamis -->
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- Baris-baris data akan ditambahkan secara dinamis -->
                </tbody>
            </table>
            <!-- <div id="InfoAPP" style="text-align:center; font-weight:bold; color:red;"></div>    
            <div id="InfoStatus" style="text-align:center; font-weight:bold; color:red;"></div>     -->
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
<script>
   // console.log("👂 Listener storage AKTIF di tab:", window.location.href);

    window.addEventListener('storage', function (event) {
       // console.log("📦 EVENT STORAGE TERDETEKSI:", event);

        if (event.key === 'MONITORING_STATUS_RUN') {
            const config = JSON.parse(event.newValue || '{}');

            if (config.run === "NO") {
                location.reload();
            } else if (config.run === "YES") {
                //console.log("▶️ Scan dimulai dari tab lain!");
                $('#startSCAN').prop('disabled', true).text('Running...');
            }
        }
    });

    toastr.options = {
        "timeOut": "2500",            // Durasi munculnya toastr dalam milidetik
        "extendedTimeOut": "2000",    // Waktu tambahan saat toastr di-hover
        "closeButton": true,          // Tampilkan tombol close (opsional)
        "progressBar": true,          // Tampilkan progress bar (opsional)
        "positionClass": "toast-top-right" // Posisi toastr (ubah sesuai kebutuhan)
    };
    
    $('.sort-toggle').on('click', function () {
        $('.sort-toggle').removeClass('active'); // Reset semua
        $(this).addClass('active');              // Aktifkan yang diklik
        const sortValue = $(this).data('sort');
        console.log('Sort by: ', sortValue); // Lanjutkan sorting logic
    });

    // Mendapatkan parameter dari URL
    const urlParams = new URLSearchParams(window.location.search);
    const chainName = urlParams.get('chain') || "bsc"; // Default ke 'bsc' jika tidak ada parameter 'chain' di URL

    // Memilih chain yang sesuai berdasarkan parameter URL
    const selectedChain = CONFIG_CHAINS[chainName] || CONFIG_CHAINS['bsc']; 

    // Mengatur konfigurasi global chain berdasarkan input dari URL
    const { Kode_Chain, Nama_Chain, URL_Chain, pairs } = selectedChain; 

    const storagePrefix = "MONITORING_V1_" + Nama_Chain.toUpperCase() + "_";
    let sortOrder = {};
    const stablecoins = ["USDT", "DAI", "USDC", "FDUSD"];

    // Fungsi umum untuk mendapatkan data dari localStorage
    function getFromLocalStorage(key, defaultValue) {
        return JSON.parse(localStorage.getItem(storagePrefix + key)) || defaultValue;
       // console.log("Data from localStorage:", data); // Debug log
    }

    // Fungsi umum untuk menyimpan data ke localStorage
    function saveToLocalStorage(key, value) {
        try {
            localStorage.setItem(storagePrefix + key, JSON.stringify(value));
           // console.log("Data saved successfully:", key);
        } catch (error) {
            // Tambahkan log untuk memverifikasi jenis error
            console.error("Error saat menyimpan data:", error);

            if (error.name === "QuotaExceededError") {
                // Tambahkan pengecekan ruang yang tersedia sebelum menyimpan
                let usedSpace = new Blob(Object.values(localStorage)).size;
                let totalSpace = 5 * 1024 * 1024; // Biasanya 5MB
                console.error(`Used space: ${usedSpace} bytes / Total allowed: ${totalSpace} bytes`);

                toastr.error("MEMORY BROWSER PENUH!!! Sisa ruang tidak mencukupi.");
            } else {
                toastr.error("Terjadi kesalahan tak terduga saat menyimpan data.");
            }
        }
    }

    // Fungsi untuk menghapus item dari localStorage
    function removeFromLocalStorage(key) {
        localStorage.removeItem(storagePrefix + key);
       // console.log("Remove from localStorage:", key); // Debug log
    }

    const TOKEN_KEY = "TOKEN_SCANNER";
    const SETTING_KEY = "DATA_SETTING";

    function downloadTokenScannerJSON() {
        // Ambil data dari localStorage
        const tokenData = getFromLocalStorage("TOKEN_SCANNER", []);
        const settingData = getFromLocalStorage("DATA_SETTING", {});

        // Gabungkan data ke dalam satu objek
        const combined = {
            "TOKEN_SCANNER": tokenData,
            "DATA_SETTING": settingData
        };

        // Konversi ke file JSON
        const blob = new Blob([JSON.stringify(combined, null, 2)], {
            type: "application/json"
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");

        a.href = url;
        a.download = "PROFIL_APP.json";
        document.body.appendChild(a);
        a.click();

        // Bersihkan elemen dan URL
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        setLastAction("DOWNLOAD PROFIL");
    }

    function uploadTokenScannerJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);

                const userConfirmed = window.confirm("APAKAH ANDA INGIN UPLOAD FILE?");
                if (!userConfirmed) {
                    toastr.info("Upload dibatalkan.");
                    return;
                }

                // Cek dan simpan data token
                if (json["TOKEN_SCANNER"]) {
                    saveToLocalStorage("TOKEN_SCANNER", json["TOKEN_SCANNER"]);
                } else {
                    console.warn("TOKEN_SCANNER tidak ditemukan di file.");
                }

                // Cek dan simpan data setting
                if (json["DATA_SETTING"]) {
                    saveToLocalStorage("DATA_SETTING", json["DATA_SETTING"]);
                } else {
                    console.warn("DATA_SETTING tidak ditemukan di file.");
                }

                setLastAction("UPLOAD PROFIL");
                toastr.success("Data berhasil diupload!");
                location.reload();

            } catch (error) {
                console.error("Error parsing JSON:", error);
                toastr.error("Format file JSON tidak valid!");
            }
        };
        reader.readAsText(file);
    }



// Fungsi untuk mendapatkan data chain berdasarkan nama chain
    function getChainData(chainName) {
        const chainData = CONFIG_CHAINS[chainName]; // base
        
        if (!chainData) {
            console.log(`Chain dengan nama ${chainName} tidak ditemukan.`);
            return null;
        }
        return {
            Kode_Chain: chainData.Kode_Chain,
            Nama_Chain: chainData.Nama_Chain,
            DEXS: chainData.DEXS,
            PAIRDEXS: chainData.PAIRDEXS,
            URL_Chain: chainData.URL_Chain, 
            DATAJSON: chainData.DATAJSON, 
            BaseFEEDEX: chainData.BaseFEEDEX, 
            CEXCHAIN: chainData.WALLET_CEX,
            ICON_CHAIN: chainData.ICON,
            COLOR_CHAIN: chainData.WARNA,
        };
    }
  
    function toggleDarkMode() {
        const isDark = document.body.classList.toggle('dark-mode');    
        document.body.classList.remove('uk-light', 'uk-dark');
        document.body.classList.add(isDark ? 'uk-dark' : 'uk-light');

        saveToLocalStorage("darkMode", isDark);
        updateDarkIcon(isDark);

        toastr.info("UBAH MODE BERHASIL!!");
        // Tunggu sebentar sebelum reload
        setTimeout(() => {
            location.reload();
        }, 500);
    }

    function updateDarkIcon(isDark) {
        const icon = document.querySelector('#darkModeToggle span');
        if (icon) {
            icon.setAttribute("uk-icon", isDark ? "icon: sun; ratio: 1.4" : "icon: moon; ratio: 1.4");
            UIkit.icon(icon).$emit('update'); // refresh ikon
        }
    }
        
   // Fungsi untuk memilih server secara acak dari array
   function getRandomServerFromCORSList() {
        const serverCORSList = getFromLocalStorage("SERVERCORS", []);  // Ambil data dari localStorage
    
        if (!serverCORSList || serverCORSList.length === 0) {
            toastr.warning("DATA SETTING TIDAK ADA, SILAKAN SYCN ULANG!!");
            return null; // Tidak ada server dalam daftar
        }
    
        // Pilih server secara acak
        const randomIndex = Math.floor(Math.random() * serverCORSList.length);
        return serverCORSList[randomIndex];
    }
    
    // Menggunakan fungsi untuk mendapatkan server CORS secara acak
    var selectedServer = getRandomServerFromCORSList();
    const DTChain = getChainData(chainName);  
    var SavedSettingData = getFromLocalStorage('DATA_SETTING', {});
    var DataTokens = getFromLocalStorage('TOKEN_SCANNER',[]);
    var MasterTokens = getFromLocalStorage('TOKEN',[]);
    var serverCORSList = getFromLocalStorage("SERVERCORS", []); 
    var WalletCEX = getFromLocalStorage("WALLET_CEX", []); 
    // Proses jika semua data valid
    var savedPairs = getFromLocalStorage("selectedPair", []);
    var savedCexs = getFromLocalStorage("selectedCEX", []);

    const dexList = [
            { id: 'D1INCH', Modal: SavedSettingData.Modal1INCH,  dex: '1inch' },
            { id: 'DODOS', Modal: SavedSettingData.ModalODOS, dex: 'odos' },
            { id: 'D0X', Modal: SavedSettingData.Modal0X,  dex: '0x' },
            { id: 'DKYBERSWAP', Modal: SavedSettingData.ModalKYBERSWAP, dex: 'kyberswap' },
            { id: 'DJUPITER', Modal: SavedSettingData.ModalJUPITER,  dex: 'jupiter' },
            { id: 'DOKX', Modal: SavedSettingData.ModalOKX,  dex: 'okx' },
            { id: 'DMAGPIE', Modal: SavedSettingData.ModalMAGPIE,  dex: 'magpie' },
            { id: 'DPARASWAP', Modal: SavedSettingData.ModalPARASWAP,  dex: 'paraswap' },
        ];

    let filteredTokens = [];

    function filterTokens(strictMode) {
        const allTokens = getFromLocalStorage("TOKEN_SCANNER", []);
        const selectedCEX = getFromLocalStorage("CEX_PILIH", []);
        const selectedDEXPAIR = getFromLocalStorage("DEXPAIR_PILIH", []);
        const selectedDEX = getFromLocalStorage("DEX_PILIH", []);

        if (!Array.isArray(allTokens) || allTokens.length === 0) {
            console.warn("No tokens available for filtering.");
            filteredTokens = [];
            updateTokenCount();
            return;
        }

       // console.warn("TOKEN PAIR", allTokens);
       // console.warn("DEX is", selectedDEX.length);

        const isNonSelected = selectedDEXPAIR.includes("NON");
        const dexPairs = Object.keys(DTChain.PAIRDEXS).filter(pair => pair !== "NON");

        filteredTokens = allTokens.filter(token => {
            if (!token?.cex || !token?.symbol_in || !token?.symbol_out) return false;

            const validCEX = selectedCEX.includes(token.cex);
            const validDexPair = selectedDEXPAIR.some(pair => token.symbol_in === pair || token.symbol_out === pair) ||
                (isNonSelected && !dexPairs.some(pair => token.symbol_in === pair || token.symbol_out === pair));

            if (!validCEX || !validDexPair || !token.status) return false;
            if (strictMode && (!token.withdrawToken || !token.depositPair || !token.withdrawPair || !token.depositToken)) return false;
            
            return true;
        }).sort((a, b) => a.symbol_in.localeCompare(b.symbol_in));  // <-- ini tambahan untuk mengurutkan

        if (filteredTokens.length === 0 && selectedCEX.length > 0 && selectedDEX.length > 0) {
            toastr.error("TIDAK ADA TOKEN-PAIR YANG SESUAI CEX/DEX/PAIRDEX !!");
            console.warn("No tokens matched the filtering criteria.");
        }

        updateTokenCount();
    }

    function updateTokenCount() {
        $("#tokenCount").text(`(${filteredTokens.length})`);
        //console.warn("Tokens data", filteredTokens);
    }

    $("#strictFilter").on("change", function() {
        filterTokens($(this).is(":checked"));
    });

    // Inisialisasi dengan status awal checkbox
    filterTokens($("#strictFilter").is(":checked"));

    // Simpan urutan awal saat data pertama kali dimuat
    let originalTokens = [...filteredTokens];

    $("input[name='toggle']").change(function () {
        var selectedOption = $("input[name='toggle']:checked").val();

        if (selectedOption === "opt_B") {
            // Urutkan Z ke A (balik dari urutan asli)
            filteredTokens = [...originalTokens].reverse();
            toastr.info("SORTING TOKEN PAIR BERUBAH KE -Z");
        } else {
            // Urutkan A ke Z (urutan asli)
            filteredTokens = [...originalTokens];
            toastr.info("SORTING TOKEN PAIR BERUBAH KE -A");
        }

        // Lakukan update tampilan sesuai perubahan sorting
        loadStoredData(filteredTokens);
    });
    
    // Mapping konfigurasi untuk setiap exchange
    const exchangeConfig = {
        GATE: {
            url: coins => `https://api.gateio.ws/api/v4/spot/order_book?limit=5&currency_pair=${coins.symbol}_USDT`,
            processData: data => processOrderBook(data)
        },
        BINANCE: {
            url: coins => `https://api.binance.me/api/v3/depth?limit=4&symbol=${coins.symbol}USDT`,
            processData: data => processOrderBook(data)
        },
        MEXC: {
            url: coins => `https://api.mexc.com/api/v3/depth?symbol=${coins.symbol}USDT&limit=5`,
            processData: data => processOrderBook(data)
        },
        INDODAX: {
            url: coins => `https://indodax.com/api/depth/${(coins.symbol).toLowerCase()}idr`,

            processData: data => {
                // Cek kalau data buy/sell tidak ada
                if (!data?.buy || !data?.sell) {
                    console.error('Invalid INDODAX response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }

                // Proses data BUY: langsung ambil 3 data teratas dari API (tidak di-sort)
                const priceBuy = data.buy
                    .slice(0, 3)
                    .map(([price, volume]) => {
                        const priceFloat = parseFloat(price);
                        const volumeFloat = parseFloat(volume);
                        return {
                            price: convertIDRtoUSDT(priceFloat),
                            volume: convertIDRtoUSDT(priceFloat * volumeFloat)
                        };
                    });

                // Proses data SELL: sort harga dari besar ke kecil, baru ambil 3 data teratas
                const priceSell = data.sell
                    .slice(0, 3)
                    .map(([price, volume]) => {
                        const priceFloat = parseFloat(price);
                        const volumeFloat = parseFloat(volume);
                        return {
                            price: convertIDRtoUSDT(priceFloat),
                            volume: convertIDRtoUSDT(priceFloat * volumeFloat)
                        };
                    });

                // Return hasil BUY dan SELL
                return { priceSell ,priceBuy};
            }
        },
     };   
    
    function convertIDRtoUSDT(idrAmount) {
        const rateUSDT = getFromLocalStorage("PriceRateUSDT", 0);
        if (!rateUSDT || rateUSDT === 0) return 0;
        return parseFloat((idrAmount / rateUSDT).toFixed(8));
    }

    function feeGasGwei() {
        const isSolana = (DTChain?.Nama_Chain || "").toLowerCase() === "solana";
        
        let lastPrice = null;  // Mendeklarasikan lastPrice agar bisa diakses secara global

        // Panggil Binance untuk semua chain
        $.ajax({
            url: 'https://data-api.binance.vision/api/v3/ticker/24hr?symbol=' + DTChain.BaseFEEDEX,
            method: 'GET'
        }).done(function (PriceResponse) {
            lastPrice = PriceResponse.lastPrice;  // Simpan nilai lastPrice
            saveToLocalStorage('PRICEGAS', lastPrice);
            console.log('BASE FEE '+DTChain.BaseFEEDEX+' FOR DEX:', lastPrice);

            // Jika bukan Solana, baru panggil Infura untuk gas fee
            if (!isSolana) {
                $.ajax({
                    url: 'https://gas.api.infura.io/v3/9d0429abadc34232af7d5c0e6ab98631/networks/' + DTChain.Kode_Chain + '/suggestedGasFees',
                    method: 'GET'
                }).done(function (gasResponse) {
                    const mediumGasFee = gasResponse.low.suggestedMaxFeePerGas;
                    saveToLocalStorage('gasGWEI', mediumGasFee);
                    console.log('FEE GAS GWEI:', mediumGasFee);
                    console.log('BASE FEE ' + DTChain.BaseFEEDEX + ' FOR DEX:', lastPrice);

                }).fail(function (error) {
                    console.error('Failed to fetch gas fee from Infura:', error);
                });
            } else {
                console.log('Chain Solana: Tidak perlu gas fee dari Infura.');
            }

        }).fail(function (error) {
            console.error('Failed to fetch price from Binance:', error);
        });
    }

    // Matikan semua elemen input di form
    function form_off() {
        $('input, select, textarea, button').prop('disabled', true);
        $('.toggle-radio').addClass('uk-disabled').removeClass('active');
    }

    // Nyalakan semua elemen input di form
    function form_on() {
        $('input, select, textarea, button').prop('disabled', false);
        $('.toggle-radio').removeClass('uk-disabled');
    }


    UIkit.util.on('#modal-setting', 'show', function () {
        form_on();
    });
                
    function cekDataAwal() {
        var info = true; // Variabel status info
        let errorMessages = []; // Array untuk menyimpan pesan error
            
        // Validasi data dan push error ke array
        if (!MasterTokens.length) {
            errorMessages.push('TIDAK ADA DATA PADA SETTINGAN!!, SILAKAN KE MENU SETTINGAN.');
            $("#MasterData").addClass("icon-wrapper");
            $("#scanner-config").hide();
            $('#UpdateWalletCEX,#LoadDataBtn,#SettingModal').css('pointer-events', 'none').css('opacity', '0.4');
            info = false;
            form_off();
        } else if (!DataTokens.length) {
            form_off();
            $("#LoadDataBtn").addClass("icon-wrapper");
            $("#scanner-config").hide();
            errorMessages.push('<b>SILAKAN LOAD DATA TERLEBIH DAHULU !!</b><br/>');
            info = false;
        } else if (!SavedSettingData || SavedSettingData.walletMeta === '-') {
            errorMessages.push('CEK, SETTINGAN APLIKASI {MODAL,WALLET ADDRESS}!');
            $("#SettingModal").addClass("icon-wrapper");
            $("#scanner-config").hide();
            form_off();
            info = false;
        } else if (!WalletCEX.length) {
            errorMessages.push('TIDAK ADA DATA WALLET CEX, SILAKAN UPDATE WALLET PADA MENU SETTINGAN!');
            $("#MasterData").addClass("icon-wrapper");
            $('#UpdateWalletCEX').css('pointer-events', 'none').css('opacity', '0.4');
            info = false;
        } else {
          //  toastr.info('⏳ Memuat Data Koin...');
            console.info('⏳ Memulai proses Memuat DATA KOIN');
            console.time('⏱️ Waktu eksekusi Memuat DATA KOIN');
            loadStoredData(filteredTokens);
            console.timeEnd('⏱️ Waktu eksekusi Memuat DATA KOIN');
            console.info('✅ Proses Memuat DATA KOIN selesai.');

            generateInputCheckbox(savedCexs, "cex-options", "", "EXCH: ", "uk-form-label uk-text-success");
            generateInputCheckbox(DTChain.DEXS, "dex-options", "D", "DEFI: ", "uk-form-label uk-text-danger");
            generateInputCheckbox(savedPairs, "dexpair-options", "", " ", "uk-form-label uk-text-primary");
            generateInputModal(DTChain.DEXS);            
            loadCheckboxSelections();

            let waktuTunggu=SavedSettingData.speedScan;
            let speed=0;
            if (waktuTunggu == "2") {
                speed = "NORMAL";
            } else if (waktuTunggu == "1.5") {
                speed = "MEDIUM";
            } else if (waktuTunggu == "1") {
                speed = "FAST";
            }else{
                speed = "ANOMALI";
            }
            $("#config").text(`FilterPNL: ${SavedSettingData.filterPNL} | Grup: ${SavedSettingData.scanPerKoin} ~ ${speed} [${SavedSettingData.jedaTimeGroup}-${SavedSettingData.jedaKoin}] | Gwei: ${parseFloat(getFromLocalStorage('gasGWEI', 0)).toFixed(2)}`)
            // hitung total token
            const jml = DataTokens.filter(item => 
                item.status === true 
            ).length;

            $('#tokenCountALL').text(`TOTAL SEMUA: ${jml} PAIR-TOKEN`);  
        }

        // Daftar file HTML target
        var targetFiles = ["multipair.html"];

        // Loop setiap file dan update href-nya
        targetFiles.forEach(function(file) {
            $('a[href="' + file + '"]').each(function() {
                var link = $(this);
                var href = link.attr('href');

                // Tambahkan parameter chain, sesuaikan separator jika sudah ada query string
                var separator = href.includes('?') ? '&' : '?';
                link.attr('href', href + separator + "chain=" + encodeURIComponent(chainName));
            });
        });

        // Tampilkan semua pesan error ke #infoAPP
        if (!info) {
            $("#infoAPP").show().html(errorMessages.join("<br/>")); // Gabungkan semua pesan error
        }

        // Proses aksi terakhir jika kondisi terpenuhi
        var dataACTION = getFromLocalStorage('HISTORY');
        if (info && dataACTION && dataACTION.time) {
            $("#infoAPP").show().text(`${dataACTION.action} at ${dataACTION.time}`);
        }
        
    }

$(document).ready(function() {  
    const config = JSON.parse(localStorage.getItem('MONITORING_STATUS_RUN') || '{}');
    if (config.run === "YES") {
        $('#startSCAN').prop('disabled', true).text('Running...');
    } else {
        $('#startSCAN').prop('disabled', false).text('Start');
    }

    // dark mode change    
    const isDark = getFromLocalStorage("darkMode", false);
    if (isDark) {
        $('body').addClass('dark-mode uk-dark').removeClass('uk-light');
    } else {
        $('body').removeClass('dark-mode uk-dark');
    }
    updateDarkIcon(isDark);
    //scroll UP
    
     var $btn = $('#scrollTopBtn');
  var THRESH = 200;

  function toggleBtn() {
    if ($(window).scrollTop() > THRESH) {
      $btn.stop(true, true).fadeIn(150);
    } else {
      $btn.stop(true, true).fadeOut(150);
    }
  }

  // Tampil/sembunyi saat scroll
  $(window).on('scroll.scrollTopBtn', toggleBtn);

  // Klik = scroll ke atas
  $btn.on('click.scrollTopBtn', function (e) {
    e.preventDefault();
    $('html, body').stop(true).animate({ scrollTop: 0 }, 500, toggleBtn);
  });

  // State awal
  toggleBtn();

    const infuraApiKey = '9d0429abadc34232af7d5c0e6ab98631';
    const urlParams = new URLSearchParams(window.location.search);
    const chain = urlParams.get('chain') || 'eth'; // Default ke 'eth' jika chain tidak ditemukan di URL

    // Definisikan RPC URL untuk masing-masing chain
    const chains = {
        eth: `https://mainnet.infura.io/v3/${infuraApiKey}`,
        bsc: 'https://bsc-dataseed.binance.org/',
        polygon: 'https://polygon-rpc.com',
        base: 'https://mainnet.base.org',
        arbitrum: `https://arbitrum-mainnet.infura.io/v3/${infuraApiKey}`,
    };

    // Tentukan URL RPC untuk chain yang dipilih
    let web3;
    if (chain === 'solana') {
        // Untuk Solana menggunakan Solana Web3.js (berbeda dari Ethereum, BSC, dll)
        web3 = new solanaWeb3.Connection(chains.solana);
    } else {
        // Untuk chain lainnya (Ethereum, BSC, Polygon, dll)
        web3 = new Web3(chains[chain]);
    }
       // console.log(Web3.version);

        if (typeof CONFIG_CEX !== 'undefined' && typeof CONFIG_CHAINS !== 'undefined') {
            const currentPage = window.location.pathname.split('/').pop(); // Mengambil bagian terakhir dari path URL
            const selectedChain = CONFIG_CHAINS[Nama_Chain.toLowerCase()];
                // Pastikan data chain ditemukan
                if (selectedChain) {                    
                    // console.log(`Data untuk chain ${chainName}:`, DTChain);                
                    // console.log(`CEXS `, CONFIG_CEX); 
                    // console.log(`DEXS `, DTChain.DEXS); 
                    // generate CEX,DEX dan PAIR
                    function hexToRgba(hex, alpha) {
                        var r = parseInt(hex.slice(1, 3), 16);
                        var g = parseInt(hex.slice(3, 5), 16);
                        var b = parseInt(hex.slice(5, 7), 16);
                        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                    }

                    var warnaAsli = selectedChain.WARNA; // Contoh: "#FF0000"
                    var warnaFaded = hexToRgba(warnaAsli, 0.1); // Alpha 0.3
                
                    // Update tampilan dengan nama chain dan warna
                    $('title').text("MULTIALL GLOBAL");
                    $('#namachain').text(Nama_Chain.toUpperCase());
                    $('#namachain2').text("CHAIN " + Nama_Chain.toUpperCase());
                    $('h2#judul').css('color', selectedChain.WARNA);
                    $('#favicon').attr('href', DTChain.ICON_CHAIN); 
                    $('#progress-bar').css('background-color', selectedChain.WARNA);
                    $('#judulmodal').css({ 'background-color': selectedChain.WARNA,  'color': 'black' });

                    $('#sinyal-container').css('color',"black");

                    $('h4#daftar').css({ 'text-align': 'center', 'color': 'black', 'background': `linear-gradient(to right, #ffffff, ${selectedChain.WARNA}, #ffffff)`, 'padding-left': '4px' });

                   
                    cekDataAwal();
                        
                    // Untuk setiap chain yang ada di CONFIG_CHAINS dibuatkan ICON LINK CHAIN
                    Object.keys(CONFIG_CHAINS).forEach(chainKey => {
                        const chain = CONFIG_CHAINS[chainKey];
                        const isActive = chain.Nama_Chain === Nama_Chain;
                        const linkHTML = `<span class="chain-link" style="${!isActive ? 'opacity: 0.3;' : ''}">
                                <a href="${currentPage}?chain=${chain.Nama_Chain}" ><img src="${chain.ICON}" alt="${chain.Nama_Chain} icon" width="${isActive ? '30' : '22'}"></a></span>`;
                        $('#chain-links-container').append(linkHTML);
                    });

                    // Terapkan background linear gradient ke header card
                    document.querySelector('.header-card').style.background = 
                        `linear-gradient(to right, ${selectedChain.WARNA} 0%,  rgb(234 234 234) 60%)`;

                } else {
                    alert(`Chain dengan nama ${Nama_Chain} tidak ditemukan.`);
                }
            } else {
                console.warn("CONFIG tidak tersedia.");
            }

            $('#searchInput').on('input', function() {
                const searchValue = $(this).val().toLowerCase();
                $('#dataTableBody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(searchValue) > -1);
                });
            });

            $(document).on('click', `[id^="MultiAll-"]`, function () {
                const index = $(this).data('index');
                const item = filteredTokens[index];
                if (!item) {
                    toastr.error("Data tidak ditemukan di filteredTokens");
                    return;
                }
                $('#multiTokenIndex').val(index);

                // Tampilkan info token dan pair di modal
                $('#infoSymbolToken').text(item.symbol_in || '-');
                $('#infoSCToken').text(item.sc_in || '-');
                $('#infoDesToken').text(item.des_in || '-');
                $('#infoSymbolPair').text(item.symbol_out || '-');
                $('#infoSCPair').text(item.sc_out || '-');
                $('#infoDesPair').text(item.des_out || '-');

                // Generate CEX checkbox tanpa input modal
                const cexList = Object.keys(CONFIG_CEX || {});
                let cexHtml = '';
                cexList.forEach(cex => {
                    cexHtml += `
                        <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                            <input type="checkbox" class="cex-checkbox" value="${cex}" style="margin-right:6px;">
                            <span style="min-width:70px;display:inline-block;">${cex}</span>
                        </div>
                    `;
                });
                $('#cex-checkbox-group').html(cexHtml);

                // Generate DEX checkbox + input modal kiri/kanan
                const dexList = (DTChain.DEXS || []);
                let dexHtml = '';
                dexList.forEach(dex => {
                    dexHtml += `
                        <div class="uk-flex uk-flex-middle uk-margin-small-bottom" style="gap:8px;">
                            <input type="checkbox" class="dex-checkbox" value="${dex}">
                            <span style="min-width:70px;display:inline-block;">${dex.toUpperCase()}</span>
                        </div>
                    `;
                });
                $('#dex-checkbox-group').html(dexHtml);

                UIkit.modal('#multiscanModal').show();
            });

            // Handler untuk form submission modal
            $(document).on('submit', '#multiTokenForm', function(e) {
                e.preventDefault();
                
                const index = $('#multiTokenIndex').val();
                const item = filteredTokens[index];
                
                if (!item) {
                    toastr.error("Data tidak ditemukan", "❌");
                    return;
                }
                
                // Ambil nilai modal
                const modalCexToDex = Number($('#modalCEX').val());
                const modalDexToCex = Number($('#modalDEX').val());
                
                // Validasi modal
                if (isNaN(modalCexToDex) || isNaN(modalDexToCex) || modalCexToDex <= 0 || modalDexToCex <= 0) {
                    toastr.error("Modal harus angka > 0", "❌ Input Salah");
                    return;
                }
                
                // Ambil CEX yang dipilih
                const selectedCexs = [];
                $('.cex-checkbox:checked').each(function() {
                    selectedCexs.push($(this).val());
                });
                
                // Ambil DEX yang dipilih
                const selectedDexs = [];
                $('.dex-checkbox:checked').each(function() {
                    selectedDexs.push($(this).val());
                });
                
                // Validasi checkbox
                if (selectedCexs.length === 0) {
                    toastr.warning("Pilih minimal 1 CEX", "⚠️ CEX Kosong");
                    return;
                }
                
                if (selectedDexs.length === 0) {
                    toastr.warning("Pilih minimal 1 DEX", "⚠️ DEX Kosong");
                    return;
                }
                
                // Ambil data dari localStorage
                const TARGET_KEY = 'MULTIALL_TOKENS';
                let tokens = JSON.parse(localStorage.getItem(TARGET_KEY) || '[]');
                if (!Array.isArray(tokens)) tokens = [];
                
                // Chain format
                const rawChain = (Nama_Chain || "bsc").toLowerCase();
                const chainFormatted = rawChain === "bsc" ? "BSC" : rawChain.charAt(0).toUpperCase() + rawChain.slice(1);
                
                // Cek duplikat
                const isExist = tokens.some(t => 
                    t.symbol.toLowerCase() === item.symbol_in.toLowerCase() && 
                    t.pairSymbol.toLowerCase() === item.symbol_out.toLowerCase() && 
                    (t.chain || '').toLowerCase() === rawChain
                );
                
                if (isExist) {
                    toastr.error("Token sudah ada di daftar", "❌ Duplikat");
                    return;
                }
                
                // Buat data token baru
                const tokenData = {
                    id: Date.now(),
                    symbol: item.symbol_in,
                    pairSymbol: item.symbol_out,
                    contractAddress: item.sc_in || '',
                    pairContractAddress: item.sc_out || '',
                    decimals: item.des_in || 18,
                    pairDecimals: item.des_out || 18,
                    chain: chainFormatted,
                    modalCexToDex,
                    modalDexToCex,
                    isActive: true,
                    selectedCexs,
                    selectedDexs
                };
                
                // Simpan ke localStorage
                tokens.push(tokenData);
                localStorage.setItem(TARGET_KEY, JSON.stringify(tokens));
                
                // Tutup modal
                UIkit.modal('#multiscanModal').hide();
                
                // Tampilkan notifikasi sukses
                toastr.success(
                    `📥 Berhasil import ${tokenData.symbol} VS ${tokenData.pairSymbol} ke Chain ${tokenData.chain}`,
                    "✅ Import Sukses",
                    {
                        timeOut: 4000,
                        closeButton: true
                    }
                );
                
                // Reset form (opsional)
                $('#multiTokenForm')[0].reset();
                $('.cex-checkbox, .dex-checkbox').prop('checked', false);
            });

            $('.posisi-check').on('change', function () {
                const kiri = $('input[value="Actionkiri"]');
                const kanan = $('input[value="ActionKanan"]');
                
                // Cek jumlah yang dicentang
                const checkedCount = $('.posisi-check:checked').length;

                if (checkedCount === 0) {
                    // Kembalikan checkbox ini ke posisi sebelumnya (ON)
                    $(this).prop('checked', true);
                    toastr.error("Minimal salah satu POSISI harus aktif!");
                    return;
                }else{
                    $("#startSCAN").show();
                }

                const label = $(this).val() === 'Actionkiri' ? 'KIRI' : 'KANAN';
                const status = $(this).is(':checked') ? 'AKTIF' : 'NONAKTIF';
                toastr.info(`POSISI ${label} ${status}`);
            });

            $('.vol-check').on('change', function () {
                const checkedVOL = $('.vol-check:checked').length;

                if (checkedVOL == true) {
                    toastr.success("Checking Volume CEX Aktif!");
                    return;
                }else{
                    toastr.error("Checking Volume CEX NON Aktif!");

                }

            });

            $('#LoadDataBtn').on('click', function () {
                const storedData = getFromLocalStorage("TOKEN", []);
                const WalletCEXData = getFromLocalStorage("WALLET_CEX", []);

                // Gabungkan data terlebih dahulu (belum di-checksum)
                let combinedData = storedData.map(token => {
                    const walletToken = WalletCEXData.find(item =>
                        item.cex === token.cex && item.tokenName === token.symbol_in
                    );

                    const walletPair = WalletCEXData.find(item =>
                        item.cex === token.cex && item.tokenName === token.symbol_out
                    );

                    return {
                        ...token,
                        feeWDToken: walletToken ? walletToken.feeWDs : "",
                        feeWDPair: walletPair ? walletPair.feeWDs : "",
                        depositPair: walletPair ? walletPair.depositEnable : false,
                        withdrawToken: walletToken ? walletToken.withdrawEnable : false,
                        depositToken: walletToken ? walletToken.depositEnable : false,
                        withdrawPair: walletPair ? walletPair.withdrawEnable : false,
                    };
                });

            
                combinedData = combinedData.map(item => {
                    let sc_in_checksum = item.sc_in || "";
                    let sc_out_checksum = item.sc_out || "";

                    // Jika bukan chain Solana → lakukan checksum
                    if ((chain || "").toLowerCase() !== "solana") {
                        if (item.sc_in && web3.utils.isAddress(item.sc_in)) {
                            sc_in_checksum = web3.utils.toChecksumAddress(item.sc_in);
                        }
                        if (item.sc_out && web3.utils.isAddress(item.sc_out)) {
                            sc_out_checksum = web3.utils.toChecksumAddress(item.sc_out);
                        }
                    }

                    // Debug hasil ke konsol
                // console.info(`[${item.chain}] [SC_IN] ${item.symbol_in}: ${item.sc_in} → ${sc_in_checksum}`);
                // console.info(`[${item.chain}] [SC_OUT] ${item.symbol_out}: ${item.sc_out} → ${sc_out_checksum}`);

                    return {
                        ...item,
                        sc_in: sc_in_checksum,
                        sc_out: sc_out_checksum
                    };
                });

                // Konfirmasi penyimpanan
                if (confirm('LOAD DATA AKAN MERUBAH DATA SEBELUMNYA, LANJUTKAN??')) {
                    saveToLocalStorage("TOKEN_SCANNER", combinedData);

                    const savedData = getFromLocalStorage("TOKEN_SCANNER", []);
                    if (savedData.length === combinedData.length) {
                        toastr.info("LOADING DATA TOKEN PAIR...", {
                            timeOut: 3000,
                            progressBar: true,
                            closeButton: true,
                        });
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        toastr.error("LOAD DATA GAGAL!", {
                            timeOut: 4000,
                            progressBar: true,
                            closeButton: true,
                        });
                    }
                } else {
                    toastr.info("PROSES LOAD DATA DIBATALKAN OLEH PENGGUNA.", {
                        timeOut: 3000,
                        progressBar: true,
                        closeButton: true,
                    });
                }
            });
            
            $("#stopSCAN").click(function () {
                // Ambil config dari localStorage terlebih dahulu
                const config = JSON.parse(localStorage.getItem('MONITORING_STATUS_RUN') || '{}');

                // Cek jika sedang berjalan
                if (config.run === "YES") {
                    // Ubah menjadi "NO"
                    config.run = "NO";
                    localStorage.setItem('MONITORING_STATUS_RUN', JSON.stringify(config));

                    // Jalankan efek stop langsung
                    clearInterval(window.autorunTimer);
                    $('#startSCAN').prop('disabled', false).text('Start');

                    alert("✅ SCAN BERHASIL DIHENTIKAN");
                    location.reload();
                } else {
                    // Kalau memang sudah NO, tidak lakukan apa-apa
                    alert("⚠️ SCAN SUDAH NONAKTIF");
                }
            });

           $("#reload").click(function () {
                const config = JSON.parse(localStorage.getItem('MONITORING_STATUS_RUN') || '{}');

                if (config.run === "YES") {
                    const confirmReset = confirm("⚠️ APAKAH ANDA INGIN RESET PROSES? \n JIKA ADA PROSES SCANNING MAKA AKAN DIHENTIKAN?");
                    
                    if (confirmReset) {
                        config.run = "NO"; // hentikan proses scan
                        localStorage.setItem('MONITORING_STATUS_RUN', JSON.stringify(config));
                        location.reload(); // reload halaman
                    } else {
                        // User menolak, tidak lakukan apa-apa
                        console.log("Reload dibatalkan oleh pengguna.");
                    }
                } else {
                    // Tidak sedang scan, langsung reload
                    location.reload();
                }
            });            
    });

    function formatPrice(price) {
        if (price >= 1) {
            return price.toFixed(3) + '$'; // Jika >= 1, tampilkan 2 angka desimal
        }

        let strPrice = price.toFixed(20).replace(/0+$/, ''); // Paksa format desimal, hapus nol di akhir
        let match = strPrice.match(/0\.(0*)(\d+)/); // Ambil nol setelah koma dan angka signifikan

        if (match) {
            let zeroCount = match[1].length; // Hitung jumlah nol setelah koma
            let significant = match[2].substring(0, 4); // Ambil 5 digit signifikan pertama

            // Jika angka signifikan kurang dari 5 digit, tambahkan nol di akhir
            significant = significant.padEnd(4, '0');

            if (zeroCount >= 2) {
                return `0.{${zeroCount}}${significant}$`; // Format dengan {N} jika nol >= 2
            } else {
                return `0.${match[1]}${significant}$`; // Format biasa jika nol < 2
            }
        }

        return price.toFixed(6) + '$'; // Fallback jika format tidak dikenali
    }

    //scan dengan batas maksimum eksekusi pergrup (speedscan)
     $("#startSCAN").click(function () {
        let config = { run: "YES" };
        localStorage.setItem('MONITORING_STATUS_RUN', JSON.stringify(config));

        // ⬇️ Eksekusi efek langsung juga di tab ini
        $('#startSCAN').prop('disabled', true).text('Running...');

        cekDataAwal();
        sendStatusTELE(SavedSettingData.nickname, 'ONLINE');
        CekIdentitas();
        $('#sinyal-container span[id^="sinyal"]').empty();
        form_off();

        $("#autoScrollCheckbox,#batalimportkoin,#importkoin").show().prop('disabled', false);
        $("#stopSCAN").show().prop('disabled', false);

        $('#LoadDataBtn, #SettingModal, #MasterData,#UpdateWalletCEX, #chain-links-container,.sort-toggle').css('pointer-events', 'none').css('opacity', '0.4');
      // ✅ aktifkan kembali input & checkbox
        $('#modalCEX, #modalDEX, #cex-checkbox-group input[type=checkbox], #dex-checkbox-group input[type=checkbox]')
        .prop('disabled', false)
        .css({ opacity: 1, 'pointer-events': 'auto' });
        
        // Pastikan checkbox tetap aktif dan bisa diubah statusnya
        $('.statusCheckbox').css({ 'pointer-events': 'auto', 'opacity': '1' }).prop('disabled', false);
        
        let ConfigScan = getFromLocalStorage('DATA_SETTING', {});
        let scanPerKoin = parseInt(ConfigScan.scanPerKoin);
        let jedaKoin = parseInt(ConfigScan.jedaKoin);
        let jedaTimeGroup = parseInt(ConfigScan.jedaTimeGroup);
        let dexList = getFromLocalStorage("DEX_PILIH", []);

        let speedScan = parseInt(getFromLocalStorage('SavedSettingData.speedScan', 500)) * 1000; // Ambil speedScan dari localStorage, default 1000ms

        // Semaphore untuk membatasi jumlah request yang berjalan secara bersamaan
        let maxConcurrentRequests = scanPerKoin; // Sesuaikan dengan batasan yang diinginkan
        let currentRequests = 0;
        let requestQueue = [];

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateProgress(current, total, startTime, TokenPair) {
            let duration = ((Date.now() - startTime) / 1000 / 60).toFixed(2);
            let progressPercentage = Math.floor((current / total) * 100);
            let progressText = `CHECKING - ${TokenPair} [${current}/${total}] :: Mulai: ${new Date(startTime).toLocaleTimeString()} ~ DURASI [${duration} Menit]`;

            $('#progress-bar').css('width', progressPercentage + '%');
            $('#progress-text').text(progressPercentage + '%');
            $('#progress').text(progressText);
        }

        // panggil di awal aplikasi atau sebelum getPriceCEX
        async function processRequest(token) {
            currentRequests++;
            try {
                let cex = token.cex.toUpperCase();
                let symbolIn = token.symbol_in.toUpperCase();
                let symbolOut = token.symbol_out.toUpperCase();
                let sc_input = token.sc_in.toString();
                let sc_output = token.sc_out.toString();
                let des_input = token.des_in;
                let des_output = token.des_out;
                let NameToken = token.symbol_in.toUpperCase();
                let NamePair = token.symbol_out.toUpperCase();

                let TokenPair = `${symbolIn}_${symbolOut}`;
                let PairToken = `${symbolOut}_${symbolIn}`;
               
                 await new Promise((resolve, reject) => {
                    let timeout = setTimeout(() => reject("Timeout"), speedScan);
                    //console.log("Detail TOKEN PAIR",token);
                    getPriceCEX(token, token.symbol_in, token.symbol_out, token.cex, (error, DataCEX) => {
                       // console.log(DataCEX);

                        clearTimeout(timeout);
                        
                        if (error || !DataCEX) {
                            console.error("Error data from CEX:", error || "Data tidak valid");
                            toastr.error(`Cek ulang harga ${token.symbol_in}/${token.symbol_out} di ${token.cex}`);
                            resolve(); // lanjut ke token berikutnya
                            $('#' + token.cex + '_' + TokenPair + '_' + (DTChain.Nama_Chain).toUpperCase()).css('background-color', '#949191');
                            return; // ⛔ Hentikan eksekusi agar tidak akses null
                        }

                        let isInvalid = false;
                        let priceBuyTokenCEX = DataCEX.volumes_buyToken?.[0]?.price || 0;
                        let priceSellTokenCEX = DataCEX.volumes_sellToken?.[0]?.price || 0;
                        let priceBuyPairCEX = DataCEX.volumes_buyPair?.[0]?.price || 0;
                        let priceSellPairCEX = DataCEX.volumes_sellPair?.[0]?.price || 0;

                        // Validasi harga
                        if (!isFinite(priceBuyTokenCEX) || priceBuyTokenCEX <= 0) {
                            toastr.error(`Tidak Dapat Harga ${token.symbol_in} pada ${token.cex}`);
                            isInvalid = true;
                        }
                        if (!isFinite(priceSellTokenCEX) || priceSellTokenCEX <= 0) {
                            toastr.error(`Tidak Dapat Harga ${token.symbol_in} pada ${token.cex}`);
                            isInvalid = true;
                        }
                        if (!isFinite(priceBuyPairCEX) || priceBuyPairCEX <= 0) {
                            toastr.error(`Tidak Dapat Harga ${token.symbol_out} pada ${token.cex}`);
                            isInvalid = true;
                        }
                        if (!isFinite(priceSellPairCEX) || priceSellPairCEX <= 0) {
                            toastr.error(`Tidak Dapat Harga ${token.symbol_out} pada ${token.cex}`);
                            isInvalid = true;
                        }

                        if (isInvalid) {
                            toastr.error(`CEK MANUAL ${token.symbol_in} di ${token.cex}`);
                            resolve();
                            $('#' + token.cex + '_' + TokenPair + '_' + (DTChain.Nama_Chain).toUpperCase()).css('background-color', '#949191');
                            return;
                        }
                        else {

                            const buyVolToken = (DataCEX.volumes_buyToken.length > 0) 
                                ? DataCEX.volumes_buyToken.reduce((min, item) => item.price < min.price ? item : min).volume 
                                : 1;

                            const sellVolPair = (DataCEX.volumes_sellToken.length > 0) 
                                ? DataCEX.volumes_sellToken.reduce((max, item) => item.price > max.price ? item : max).volume 
                                : 1;

                            dexList.forEach((dex) => {
                                let IdTokentoPair = `${cex}_${dex.toUpperCase()}_${TokenPair}_${(DTChain.Nama_Chain).toUpperCase()}`;
                                let IdPairtoToken = `${cex}_${dex.toUpperCase()}_${PairToken}_${(DTChain.Nama_Chain).toUpperCase()}`;
                               
                                   // Mendapatkan nilai modal kiri dan kanan dari localStorage
                                let modalKeyKiri = `MODAL_KIRI_${dex.toUpperCase()}`;
                                let modalKeyKanan = `MODAL_KANAN_${dex.toUpperCase()}`;
                                
                                let modalKiri = SavedSettingData[modalKeyKiri];
                                let modalKanan = SavedSettingData[modalKeyKanan];
                                
                                let dextype = dex.toLowerCase();
                                
                                // Perhitungan untuk modal kiri dan kanan
                                var amount_in_token = parseFloat(modalKiri) / parseFloat(priceBuyTokenCEX);
                                var amount_in_pair = parseFloat(modalKanan) / parseFloat(priceBuyPairCEX);
                                
                                // dari KIRI
                                // token to pair
                                if ($(`#${IdTokentoPair}`).length && $('input[type="checkbox"][value="Actionkiri"]').is(':checked')) {
                                    getPriceDEX(sc_input, des_input, sc_output, des_output, amount_in_token, priceBuyPairCEX, dextype, NameToken, NamePair, cex,'TokentoPair', function (error, DataDEX) {
                                       // console.log(sc_input, des_input, sc_output, des_output, amount_in_token, priceBuyPairCEX, dextype, NameToken, NamePair, cex,'TokentoPair');
                                        if (error || !DataDEX) {
                                            $(`#${IdTokentoPair}`).css('background-color', error.color);
                                            $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${error.pesanDEX}">[ERROR]</span>`);
                                            //    if(dextype == "odos"){
                                            //         console.log("ODOS KIRI",error)
                                            //     }    
                                                if ((error.statusCode == 500 && (dextype == "odos" ))){
                                                   // toastr.info(`KIRI!! ${TokenPair} ${dextype} PINDAH SERVER`);
                                                    var amount_in = BigInt(Math.round(Math.pow(10, des_input) * amount_in_token));
                                                    getPriceSWOOP(sc_input, des_input, sc_output, des_output, amount_in, priceBuyPairCEX, dextype, NameToken, NamePair, cex,'TokentoPair', function (altError, altDataDEX){  
                                                        if (!altError) {
                                                           // $(`#${IdTokentoPair}`).css('background-color', '#ded5d5');
                                                            $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                            $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                                ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_input, sc_output, cex, modalKiri, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair',buyVolToken,altDataDEX);
                                                            }
                                                        else{
                                                                $(`#${IdTokentoPair}`).css('background-color',altError.color);
                                                                $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${altError.pesanDEX}">[ERROR]</span>`);
                                                        }
                                                    });
                                                }

                                            return;
                                            } else {
                                                $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                
                                                ResultEksekusi(DataDEX.amount_out,DataDEX.FeeSwap,sc_input, sc_output, cex, modalKiri, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair',buyVolToken,DataDEX);
                                            }
                                        });                     
                                    }

                                // pair to token
                                // DARI KANAN
                               // if ($(`#${IdPairtoToken}`).length) {
                                if ($(`#${IdPairtoToken}`).length && $('input[type="checkbox"][value="ActionKanan"]').is(':checked')) {
                                     getPriceDEX( sc_output, des_output,sc_input, des_input, amount_in_pair, priceBuyPairCEX, dextype, NamePair, NameToken, cex,'PairtoToken', function (error, DataDEX) {
                                        // console.log( sc_output, des_output,sc_input, des_input, amount_in_pair, priceBuyPairCEX, dextype, NamePair, NameToken, cex,'PairtoToken');
                                        if (error || !DataDEX) {
                                            $(`#${IdPairtoToken}`).css('background-color', error.color);
                                            $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${error.pesanDEX}">[ERROR]</span>`);
                                                // if(dextype == "odos"){
                                                //     console.log("ODOS KANAN",error)
                                                // }    
                                               
                                                    if ((error.statusCode == 0 && (dextype == "odos"))) {
                                                    // toastr.info(`KANAN!! ${PairToken} ${dextype} PINDAH SERVER`);
                                                        var amount_in = Math.pow(10, des_output) * amount_in_pair;
                                                        getPriceSWOOP( sc_output, des_output,sc_input, des_input, amount_in, priceBuyPairCEX, dextype, NamePair, NameToken, cex,'PairtoToken', function (altError, altDataDEX){                                                                
                                                            if (!altError) {
                                                               // $(`#${IdPairtoToken}`).css('background-color', '#ded5d5');
                                                                $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                                                $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);

                                                                ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_output, sc_input, cex, modalKanan, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken',sellVolPair,altDataDEX);
                                                            }else{
                                                                $(`#${IdPairtoToken}`).css('background-color',altError.color);
                                                                $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${altError.pesanDEX}">[ERROR]</span>`);
                                                            }
                                                        });
                                                }  
                                             
                                            return;
                                        } 
                                        else {                                         
                                            //$(`#${IdPairtoToken}`).css('background-color', "#faf6f6");
                                                $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                                $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);
                                                ResultEksekusi(DataDEX.amount_out,DataDEX.FeeSwap,sc_output, sc_input, cex, modalKanan, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken',sellVolPair,DataDEX);
                                           }
                                        
                                    });
                                }
                                
                            });

                            resolve();
                        }
                    });
                });

                await delay(jedaKoin);
            } catch (error) {
                console.error(`Kesalahan saat memproses ${token.symbol_in}_${token.symbol_out}:`, error);
            } finally {
                currentRequests--;
                if (requestQueue.length > 0) {
                    let nextRequest = requestQueue.shift();
                    nextRequest();
                }
            }
        }

        async function processTokens() {
            let startTime = Date.now();
            let totalTokens = filteredTokens.length;
            let currentProcessed = 0;

            let tokenGroups = [];
            for (let i = 0; i < filteredTokens.length; i += scanPerKoin) {
                tokenGroups.push(filteredTokens.slice(i, i + scanPerKoin));
            }

            for (let groupIndex = 0; groupIndex < tokenGroups.length; groupIndex++) {
                let groupTokens = tokenGroups[groupIndex];
                 console.log(`Memproses grup ${groupIndex + 1} dari ${tokenGroups.length}`);

                // 🔹 Auto Scroll sekali di awal grup
                if ($('#autoScrollCheckbox').is(':checked')) {
                    let firstToken = groupTokens[0];
                    let rowId = `${firstToken.cex}_${firstToken.symbol_in.toUpperCase()}_${firstToken.symbol_out.toUpperCase()}_${(DTChain.Nama_Chain).toUpperCase()}`;
                    let targetRow = document.getElementById(rowId);
                    if (targetRow) {
                        targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                feeGasGwei();
                getRateUSDT(); // panggil di awal aplikasi atau sebelum getPriceCEX

                for (let tokenIndex = 0; tokenIndex < groupTokens.length; tokenIndex++) {
                    let token = groupTokens[tokenIndex];

                    updateProgress(
                        currentProcessed + tokenIndex + 1,
                        totalTokens,
                        startTime,
                        `${token.symbol_in}_${token.symbol_out}`
                    );

                    if (currentRequests >= maxConcurrentRequests) {
                        await new Promise(resolve => requestQueue.push(resolve));
                    }

                    await processRequest(token);
                }

                currentProcessed += groupTokens.length;
                console.log(`Grup ${groupIndex + 1} selesai diproses`);
                await delay(jedaTimeGroup);
            }


            updateProgress(totalTokens, totalTokens, startTime, "SELESAI");
            form_on();

            $("#stopSCAN").hide().prop("disabled", false);
                // 🔃 Jika belum jalan, lanjutkan
            config.run = "NO";
            localStorage.setItem('MONITORING_STATUS_RUN', JSON.stringify(config));
            $('#startSCAN').prop('disabled', false).text('Start');

            $("#LoadDataBtn, #SettingModal, #MasterData,#UpdateWalletCEX,#chain-links-container,.sort-toggle").css("pointer-events", "auto").css("opacity", "1");
        }

        processTokens();
    });

    //genereta inputan checkbox
    function generateInputCheckbox(items, containerId, idPrefix, labelText, style) {
        const $container = $(`#${containerId}`);
        $container.empty(); // Bersihkan container

        // Variabel untuk jumlah token (khusus untuk cex-options)
        let jml = 0;
        // Hitung jumlah token hanya jika containerId adalah "cex-options"
        if (containerId === "cex-options") {
            jml = filteredTokens.filter(t => t.status === true && items.includes(t.cex)).length;
        }
   
        // Tambahkan label di atas checkbox
        const label = `
            <b>
                <span class="uk-text-secondary uk-text-medium">
                    ${labelText}
                </span>
            </b>
        `;
        $container.append(label);

        // Jika `items` adalah objek, ubah menjadi array key
        if (typeof items === 'object' && !Array.isArray(items)) {
            items = Object.keys(items); // Ambil key dari objek
        }

        // Iterasi dan tambahkan checkbox beserta label
        const checkboxWrapper = $('<div style="display: flex; flex-wrap: wrap; gap: 10px;"></div>'); // Bungkus checkbox
        items.forEach(item => {
            const checkboxId = `${idPrefix}${item.toUpperCase()}`;

            const countForCEX = containerId === "cex-options" 
                ? DataTokens.filter(t => t.status === true && t.cex === item).length 
                /*  && t.depositPair === true && t.withdrawToken === true && t.depositToken === true && t.withdrawPair === true).length */
                : ""; // Hanya hitung jumlah token untuk cex-options
            const checkbox = `
                <label class="${style || ''}" for="${checkboxId}">
                    <input type="checkbox" id="${checkboxId}" value="${item}" checked>
                    ${item.toUpperCase()}${containerId === "cex-options" ? ` (${countForCEX})` : ""}
                </label>`;
            checkboxWrapper.append(checkbox);
        });

        $container.append(checkboxWrapper); // Masukkan checkbox ke dalam container
    }

    // Fungsi untuk memuat data dari localStorage saat halaman dimuat
    function loadCheckboxSelections() {
        let errorMessages = [];
        // Muat data CEX
        const savedCEX = getFromLocalStorage("CEX_PILIH", []);
        $('#cex-options input[type="checkbox"]').each(function() {
            $(this).prop('checked', savedCEX.includes($(this).val()));
        });
        // Muat data DEX
        const savedDEX = getFromLocalStorage("DEX_PILIH", []);
        $('#dex-options input[type="checkbox"]').each(function() {
            $(this).prop('checked', savedDEX.includes($(this).val()));
        });

        // Muat data DEXPAIR
        const savedDEXPAIR = getFromLocalStorage("DEXPAIR_PILIH", []);
        $('#dexpair-options input[type="checkbox"]').each(function() {
            $(this).prop('checked', savedDEXPAIR.includes($(this).val()));
        });

      //  const pilihCex = getFromLocalStorage('CEX_PILIH', null);
        if (!savedCEX || !Array.isArray(savedCEX) || savedCEX.length === 0) {
            errorMessages.push('SILAKAN PILIH CEX!');
            $("#cex-options").addClass("error");
            form_on(); // tetap off jika `PILIH_CEX` belum diatur
        }
        
        //const pilihDex = getFromLocalStorage('DEX_PILIH', null);
        if (!savedDEX || !Array.isArray(savedDEX) || savedDEX.length === 0) {
            errorMessages.push('SILAKAN PILIH DEX!');
            $("#dex-options").addClass("error");
            form_on(); // tetap off jika `PILIH_DEX_PAIR` belum diatur
        }  
       // const pilihDexPair = getFromLocalStorage('DEXPAIR_PILIH', null);
        if (!savedDEXPAIR || !Array.isArray(savedDEXPAIR) || savedDEXPAIR.length === 0) {
            errorMessages.push('SILAKAN PILIH DEX PAIR!');
            $("#dexpair-options").addClass("error");
            form_on(); // tetap off jika `PILIH_DEX_PAIR` belum diatur
        }   
        $("#InfoAPP").html(errorMessages.join('<br/>')).addClass("text-large");    
    }
   
    $("#strictFilter").on("change", function() {
        var useStrictFilter = $(this).is(":checked");
        console.log("CLOSE WALLET DEX:", useStrictFilter);
    });

    // Fungsi untuk menentukan warna berdasarkan nama CEX
    function getWarnaCEX(cex) {
        const cexConfig = CONFIG_CEX[cex.toUpperCase()]; // Ambil konfigurasi berdasarkan nama CEX
        return cexConfig && cexConfig.WARNA ? cexConfig.WARNA : 'black'; // Gunakan warna dari konfigurasi atau 'black' jika tidak ditemukan
    }
    //SIGNAL DINAMIS BENTUK CARD
    function loadSignalData() {
        let selectedDEX = getFromLocalStorage('DEX_PILIH', []); 
        const appSettings = getFromLocalStorage('DATA_SETTING', {});

        let sinyalContainer = document.getElementById('sinyal-container');
        sinyalContainer.innerHTML = '';

        // Grid horizontal UIkit
        sinyalContainer.classList.add('uk-grid', 'uk-child-width-expand@s', 'uk-grid-small');
        sinyalContainer.setAttribute('uk-grid', '');

        selectedDEX.forEach(dex => {
            // Get left and right modal values
            const modalLeft = appSettings[`MODAL_KIRI_${dex.toUpperCase()}`] || 0;
            const modalRight = appSettings[`MODAL_KANAN_${dex.toUpperCase()}`] || 0;

            // Grid item
            let gridItem = document.createElement('div');

            // Card UIkit dengan radius & border rapi
            let card = document.createElement('div');
            card.classList.add('uk-card', 'uk-card-default', 'uk-card-hover');
            card.style.borderRadius = '5px';
            card.style.overflow = 'hidden';
            card.style.border = `1px solid ${getWarnaCEX(dex)}`;

            // Header card
            let cardHeader = document.createElement('div');
            cardHeader.classList.add('uk-card-header', 'uk-padding-remove-vertical', 'uk-padding-small');
            cardHeader.style.backgroundColor = selectedChain.WARNA;
            cardHeader.style.height = '30px';
            cardHeader.style.lineHeight = '20px';
            cardHeader.style.display = 'flex';
            cardHeader.style.alignItems = 'center';
            cardHeader.style.justifyContent = 'space-between';
            cardHeader.innerHTML = `
                <span class="uk-text-bold uk-text-secondary" style="color:#000; font-size: 13.5px;">
                    ${dex.toUpperCase()} 
                    &nbsp;<span style="background-color:white;" class="uk-text-bold"> 
                        <span class="uk-text-success"> KIRI: $${modalLeft} </span> | <span class="uk-text-danger"> KANAN: $${modalRight}  </span>
                     </span> &nbsp;
                </span>
            `;

            // Body card
            let cardBody = document.createElement('div');
            cardBody.classList.add('uk-card-body', 'uk-padding-small', 'uk-background-muted');
            cardBody.style.padding = '8px 12px';

            // Tempat sinyal
            let signalSpan = document.createElement('div');
            signalSpan.setAttribute('id', `sinyal${dex.toLowerCase()}`);
            signalSpan.style.fontSize = '12.3px';
            signalSpan.style.whiteSpace = 'normal';
            signalSpan.style.wordWrap = 'break-word';
            signalSpan.style.overflowWrap = 'break-word';
            signalSpan.style.lineHeight = '1.4';
            signalSpan.style.color = '#333';
            signalSpan.style.fontFamily = 'unset';

            // Gabungkan elemen
            cardBody.appendChild(signalSpan);
            card.appendChild(cardHeader);
            card.appendChild(cardBody);
            gridItem.appendChild(card);
            sinyalContainer.appendChild(gridItem);
        });
    }

    function createLink(url, text, className = '') {
        return url
            ? `<a href="${url}" target="_blank" class="${className}"><b>${text}</b></a>`
            : `<b>${text}</b>`;
    }
    
    function createHoverLink(url, text, className = '') {
        const span = document.createElement('span');
        span.textContent = text;
        span.className = `hover-link ${className}`;
        span.dataset.url = url;
        span.title = url; // Tooltip saat hover
        return span.outerHTML;
    }

    function loadStoredData(filteredData) {
       // console.log("LOAD DATA KOIN KE TABEL", filteredData);

        $('.table-header th').css('background-color', DTChain.COLOR_CHAIN);
        loadSignalData();
       // console.warn("KOIN FILTERING",filteredData);
        const selectedDEX = getFromLocalStorage('DEX_PILIH', []);
        const appSettings = getFromLocalStorage('DATA_SETTING', {});
        const $InfoStatus = $('#InfoStatus');
        const $tableBody = $('#dataTableBody');
        const $headerRow = $('.table-header');

        $InfoStatus.text("Sedang Memuat DATA TOKEN...").show();

        if (!Array.isArray(filteredData) || filteredData.length === 0) {
            $InfoStatus.text("Tidak ada data token yang ditemukan.");
            setTimeout(() => $InfoStatus.fadeOut(), 2000);
            return;
        }

        // Kosongkan tabel dengan lebih efisien
        while ($tableBody.firstChild) {
            $tableBody.removeChild($tableBody.firstChild);
        }

        $tableBody.empty(); 
        // Optimasi Header dengan Fragment
        if ($headerRow.children().length !== selectedDEX.length + 4) {
            const headerFragment = document.createDocumentFragment();
            $headerRow.empty();

            // Kolom pertama
            let th = document.createElement('th');
            th.className = 'header';
            th.textContent = 'PRICE & VOL BUY';
            headerFragment.appendChild(th);

            // Kolom DEX untuk sisi kiri (BUY)
            selectedDEX.forEach(dex => {
                const dexUpper = dex.toUpperCase();
                const modalKiri = appSettings[`MODAL_KIRI_${dexUpper}`] || 0;

                let th = document.createElement('th');
                th.className = 'header';
                th.textContent = `${dex} [${modalKiri}]`; // Tampilkan modal kiri
                headerFragment.appendChild(th);
            });

            // Kolom tengah
            th = document.createElement('th');
            th.className = 'header';
            th.textContent = 'DETAIL TOKEN';
            headerFragment.appendChild(th);

            // Kolom DEX untuk sisi kanan (SELL)
            selectedDEX.forEach(dex => {
                const dexUpper = dex.toUpperCase();
                const modalKanan = appSettings[`MODAL_KANAN_${dexUpper}`] || 0;

                let th = document.createElement('th');
                th.className = 'header';
                th.textContent = `${dex} [${modalKanan}]`; // Tampilkan modal kanan
                headerFragment.appendChild(th);
            });

            // Kolom terakhir
            th = document.createElement('th');
            th.className = 'header';
            th.textContent = 'PRICE & VOL SELL';
            headerFragment.appendChild(th);

            $headerRow.append(headerFragment);
        }

        const fragment = document.createDocumentFragment();

        filteredData.forEach((data, index) => {
            const warnaCEX = getWarnaCEX(data.cex);
            const urlsCEX = GeturlExchanger(data.cex, data.symbol_in, data.symbol_out);
            const urlsCEXToken = GeturlExchanger(data.cex, data.symbol_in, data.symbol_in);
            const urlsCEXPair = GeturlExchanger(data.cex, data.symbol_out, data.symbol_out);

            // Status withdraw dan deposit dengan link
            const withdrawToken = data.withdrawToken ? createHoverLink(urlsCEXToken.withdrawUrl, 'WD') : `<b style="color:red; font-weight:bold;">WX</b>`;
            const depositToken = data.depositToken ? createHoverLink(urlsCEXToken.depositUrl, 'DP') : `<b style="color:red; font-weight:bold;">DX</b>`;

            const withdrawPair = data.withdrawPair ? createHoverLink(urlsCEXPair.withdrawUrl, 'WD') : `<b style="color:red; font-weight:bold;">WX</b>`;
            const depositPair = data.depositPair ? createHoverLink(urlsCEXPair.depositUrl, 'DP') : `<b style="color:red; font-weight:bold;">DX</b>`;

            // Link untuk SC dan stok token pair
            const linkToken = createHoverLink(urlsCEX.tradeToken, data.symbol_in.toUpperCase());
            const linkPair = createHoverLink(urlsCEX.tradePair, data.symbol_out.toUpperCase());
            
            const linkStokToken = Object.keys(DTChain.CEXCHAIN[data.cex])
                .filter((key) => key.includes('address'))
                .map((key, idx) => createHoverLink(`${DTChain.URL_Chain}/token/${data.sc_in}?a=${DTChain.CEXCHAIN[data.cex][key]}`, `#${idx + 1} `))
                .join('');

            const linkStokPair = Object.keys(DTChain.CEXCHAIN[data.cex])
                .filter((key) => key.includes('address'))
                .map((key, idx) => createHoverLink(`${DTChain.URL_Chain}/token/${data.sc_out}?a=${DTChain.CEXCHAIN[data.cex][key]}`, `#${idx + 1} `))
                .join('');

            // Link DEX
            let chainName = DTChain.Nama_Chain.toUpperCase();
            if (DTChain.Nama_Chain === "ethereum") {
                chainName = "ETH";
            }

            let chainName2 = DTChain.Nama_Chain.toLowerCase();
            if (DTChain.Nama_Chain === "bsc") {
                chainName2 = "bnb";
            }

            const linkOKDEX = createHoverLink(`https://www.okx.com/web3/dex-swap?inputChain=${DTChain.Kode_Chain}&inputCurrency=${data.sc_in}&outputChain=501&outputCurrency=${data.sc_out}`, '#OKX', 'uk-text-secondary');
            const linkUNIDEX = createHoverLink(`https://app.unidex.exchange/?chain=${DTChain.Nama_Chain}&from=${data.sc_in}&to=${data.sc_out}`, '#UND', 'uk-text-secondary');
            const linkRango = createHoverLink(`https://app.rango.exchange/bridge?fromBlockchain=${chainName}&toBlockchain=${chainName}&fromToken=${data.symbol_in}--${data.sc_in}&toToken=${data.symbol_out}--${data.sc_out}`, '#RGX', 'uk-text-success');
          //  const linkRBX = createHoverLink(`https://app.rubic.exchange/?fromChain=${chainName}&toChain=${chainName}&from=${data.sc_in}&to=${data.sc_out}`, '#RBCX', 'uk-text-warning');
            const linkDEFIL = createHoverLink(`https://swap.defillama.com/?chain=${DTChain.Nama_Chain}&from=${data.sc_in}&to=${data.sc_out}`, '#DFL', 'uk-text-primary');
          //  const OPEN = createHoverLink(` https://app.openocean.finance/swap/${DTChain.Nama_Chain}/${data.symbol_in}/${data.symbol_out}`, '#OPEN', 'uk-text-danger');
          //  const FINCH = createHoverLink(`https://app.1inch.io/swap?src=${DTChain.Kode_Chain}:${data.symbol_in}&dst=${DTChain.Kode_Chain}:${data.symbol_out}`, '#1INCH', 'uk-text-warning');
          //  const linkRelay = createHoverLink(`https://relay.link/bridge/${chainName2}?fromChainId=${DTChain.Kode_Chain}&fromCurrency=${data.sc_in}&toCurrency=${data.sc_out}`, '#RX', 'uk-text-warning');
            const linkLiFi = createHoverLink(`https://jumper.exchange/?fromChain=${DTChain.Kode_Chain}&fromToken=${data.sc_in}&toChain=${DTChain.Kode_Chain}&toToken==${data.sc_out}`, '#LFX', 'uk-text-warning');
          //  const Link1INCH = createHoverLink(`https://app.1inch.io/advanced/swap?network=${DTChain.Kode_Chain}&src=${data.sc_in}&dst=${data.sc_out}`, '#1NC', 'uk-text-danger');

           let row = document.createElement('tr');
            row.dataset.index = index;
            row.id = `${data.cex}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}`;

            // Kolom pertama: PRICE & VOL BUY
            let tdBuyInfo = document.createElement('td');
            tdBuyInfo.className = 'uk-text-success';
            tdBuyInfo.style.textAlign = 'center';
            tdBuyInfo.style.verticalAlign = 'middle';
            tdBuyInfo.innerHTML = `
                <span id="LEFT_${data.cex}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}">
                    PRICE & VOL BUY <br>${data.cex}
                </span>
            `;
            row.appendChild(tdBuyInfo);

            // Kolom DEX kiri (BUY)
            selectedDEX.forEach(dex => {
                const idCELL = `${data.cex}_${dex.toUpperCase()}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}`;
                let td = document.createElement('td');
                td.className = 'uk-text-center';
                td.style.verticalAlign = 'middle';
                td.id = idCELL;

                let innerHTML = `
                    <span class="buy" id="LEFT_${idCELL}" title="LEFT_${idCELL}">  </span><br>
                    <span class="uk-text-primary uk-text-bolder" id="SWAP_${idCELL}"> ${dex.toUpperCase()} </span><br>
                     <span class="sell" id="RIGHT_${idCELL}" title="RIGHT_${idCELL}">  </span><br>
                    <hr class="uk-divider-small uk-margin-remove">
                    <span class="uk-text-primary" id="RESULT_${idCELL}">  </span>
                `;
                td.innerHTML = innerHTML;
                row.appendChild(td);
            });

            // Kolom DETAIL TOKEN
            let detailTd = document.createElement('td');
            detailTd.className = 'uk-text-center uk-text-nowrap';
            // Contoh: tambahkan transparansi pada warna chain
            const hex = selectedChain.WARNA.replace('#', '');
            const r = parseInt(hex.substring(0,2), 16);
            const g = parseInt(hex.substring(2,4), 16);
            const b = parseInt(hex.substring(4,6), 16);
            detailTd.style.backgroundColor = `rgba(${r},${g},${b},0.18)`;

            detailTd.innerHTML = `
                <input type="checkbox" class="statusCheckbox" data-id="${index}" data-index="${data.no}" ${data.status ? 'checked' : ''}>#${index+1}               
                <span style="color: ${warnaCEX}; font-weight:bolder;">${data.cex} </span>
               
                <span id="MultiAll-${index}" data-index="${index}" uk-icon="icon:crosshairs; ratio: 0.7"  class="uk-text-secondary uk-text-bolder"  style="cursor:pointer"> </span><br/>
                <span class="uk-text-danger uk-text-bolder">${linkToken} VS ${linkPair}</span><br/>
                <span class="uk-text-primary uk-text-bolder">${withdrawToken}~${depositToken}</span> | 
                <span class="uk-text-primary uk-text-bolder">${withdrawPair}~${depositPair}</span><br/>
                <span class="uk-text-primary uk-text-bolder">${data.symbol_in}</span> 
                <a href="${DTChain.URL_Chain}/token/${data.sc_in}" target="_blank" class="uk-link">[SC]</a>: ${linkStokToken}<br>    
                <span class="uk-text-primary uk-text-bolder">${data.symbol_out}</span> 
                <a href="${DTChain.URL_Chain}/token/${data.sc_out}" target="_blank" class="uk-link">[SC]</a>: ${linkStokPair}<br>                   
                ${linkUNIDEX} ${linkOKDEX} ${linkDEFIL} ${linkLiFi}
            `;
            row.appendChild(detailTd);

            // Kolom DEX kanan (SELL)
            selectedDEX.forEach(dex => {
                const idCELL = `${data.cex}_${dex.toUpperCase()}_${data.symbol_out}_${data.symbol_in}_${DTChain.Nama_Chain.toUpperCase()}`;
                let td = document.createElement('td');
                td.className = 'uk-text-center';
                td.style.verticalAlign = 'middle';
                td.id = idCELL;

                let innerHTML = `
                     <span class="buy" id="LEFT_${idCELL}" title="LEFT_${idCELL}">  </span><br>
                    <span class="uk-text-primary uk-text-bolder" id="SWAP_${idCELL}"> ${dex.toUpperCase()} </span><br>
                     <span class="sell" id="RIGHT_${idCELL}" title="RIGHT_${idCELL}">  </span><br>
                    <hr class="uk-divider-small uk-margin-remove">
                    <span class="uk-text-primary" id="RESULT_${idCELL}">  </span>
                `;
                td.innerHTML = innerHTML;
                row.appendChild(td);
            });

            // Kolom terakhir: PRICE & VOL SELL
            let tdSellInfo = document.createElement('td');
            tdSellInfo.className = 'uk-text-danger';
            tdSellInfo.style.textAlign = 'center';
            tdSellInfo.style.verticalAlign = 'middle';
            tdSellInfo.innerHTML = `
                <span id="RIGHT_${data.cex}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}">
                    PRICE & VOL SELL <br>${data.cex}
                </span>
            `;
            row.appendChild(tdSellInfo);

            // Tambahkan row ke fragment
            fragment.appendChild(row);

        });

        $tableBody.append(fragment);

        $('#tokenCount').text(`(${filteredData.length})`);

        $InfoStatus.text("SELESAI, Memuat DATA TOKEN !!");
        setTimeout(() => $InfoStatus.fadeOut(), 2000);

        $(".table-header th").css({
            "background-color": selectedChain.WARNA,
            "color": "white",
            "position": "sticky",
            "font-size":"12.5px",
            "top": "0",
            "font-weight": "bolder",
            "text-align": "center",
            "z-index": "10"
        });

        updateSortIcons();
    }
 
    document.addEventListener('mouseover', function (e) {
        const el = e.target;
        if (el.classList.contains('hover-link') && el.dataset.url) {
            // Cegah duplikat dengan memeriksa parent tag A
            if (el.closest('a')) return;

            const a = document.createElement('a');
            a.href = el.dataset.url;
            a.target = '_blank';
            a.className = el.className;
            a.dataset.linked = 'true'; // mencegah hover ulang
            a.innerHTML = `<b>${el.textContent}</b>`;
            el.replaceWith(a);
        }
    });
    // FUNGSI ubah status tokenpair atau hapus token jika di-uncheck
    $(document).on('change', '.statusCheckbox', function (event) {
        event.preventDefault();
        const id = $(this).data('id');
        const no = $(this).data('index');
        const isChecked = $(this).prop('checked');
        let storedData = getFromLocalStorage('TOKEN_SCANNER', []);
        const selectedCEX = getFromLocalStorage('CEX_PILIH', []);
        const token = storedData.find(t => t.no === no);

        if (token) {
            if (!isChecked) {
                // Jika checkbox di-uncheck, hapus token dari localStorage
                if (confirm(`YAKIN, NONAKTIF ${token.symbol_in} VS ${token.symbol_out}?`)) {
                    storedData = storedData.filter(t => t.no !== no);
                    saveToLocalStorage('TOKEN_SCANNER', storedData);
                    $('tr[data-index="' + id + '"]').remove(); // Hapus baris dari tabel
                    toastr.info(`PAIR ${token.symbol_in}-${token.symbol_out} BERHASIL DI NONAKTIFKAN!`);
                } else {
                    $(this).prop('checked', true); // Batalkan uncheck jika tidak konfirmasi
                    return;
                }
            } else {
                // Jika checkbox dicentang, tandai status = true
                token.status = true;
                saveToLocalStorage('TOKEN_SCANNER', storedData);
                toastr.info(`PAIR ${token.symbol_in}-${token.symbol_out} diaktifkan!`);
            }

            // Ambil ulang data dan hitung ulang jumlah aktif
            const allData = getFromLocalStorage('TOKEN_SCANNER', []);

            const jml = allData.filter(item => item.status === true).length;
            $('#tokenCountALL').text(`TOTAL SEMUA : ${jml} PAIR-TOKEN`);

            const savedCexs = [...new Set(allData.map(t => t.cex))];
            const tokenCounts = savedCexs.reduce((acc, cex) => {
                acc[cex] = allData.filter(t => t.cex === cex && t.status === true).length;
                return acc;
            }, {});

            savedCexs.forEach(cex => {
                const countText = ` (${tokenCounts[cex] || 0})`;
                const isCheckedCEX = selectedCEX.includes(cex);
                $(`#cex-options label:contains(${cex.toUpperCase()})`).each(function () {
                    const labelText = $(this).text().split('(')[0].trim();
                    $(this).html(`
                        <input type="checkbox" value="${cex}" ${isCheckedCEX ? 'checked' : ''}>
                        ${labelText}${countText}
                    `);
                });
            });
        }
    });

    //generate url cex
    function GeturlExchanger(cex, NameToken, NamePair) {
        // Konversi nama token dan pasangan ke uppercase
        const token = NameToken.toUpperCase();
        const pair = NamePair.toUpperCase();

        let baseUrlTradeToken = token === "USDT" ? "#" : null;
        let baseUrlTradePair = pair === "USDT" ? "#" : null;
        let baseUrlWithdraw = null;
        let baseUrlDeposit = null;

        // Menentukan URL berdasarkan nilai cex
        if (cex === "GATE") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.gate.com/trade/${token}_USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.gate.com/trade/${pair}_USDT`;
            baseUrlWithdraw = `https://www.gate.com/myaccount/withdraw/${token}`;
            baseUrlDeposit = `https://www.gate.com/myaccount/deposit/${pair}`;
        } else if (cex === "BINANCE") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.binance.com/en/trade/${token}_USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.binance.com/en/trade/${pair}_USDT`;
            baseUrlWithdraw = `https://www.binance.com/en/my/wallet/account/main/withdrawal/crypto/${token}`;
            baseUrlDeposit = `https://www.binance.com/en/my/wallet/account/main/deposit/crypto/${pair}`;
        } else if (cex === "KUCOIN") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.kucoin.com/trade/${token}-USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.kucoin.com/trade/${pair}-USDT`;
            baseUrlWithdraw = `https://www.kucoin.com/assets/withdraw/${token}`;
            baseUrlDeposit = `https://www.kucoin.com/assets/coin/${pair}`;
        } else if (cex === "BITGET") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bitget.com/spot/${token}USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bitget.com/spot/${pair}USDT`;
            baseUrlWithdraw = `https://www.bitget.com/asset/withdraw`;
            baseUrlDeposit = `https://www.bitget.com/asset/recharge`;
        } else if (cex === "BYBIT") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bybit.com/en/trade/spot/${token}/USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bybit.com/en/trade/spot/${pair}/USDT`;
            baseUrlWithdraw = "https://www.bybit.com/user/assets/withdraw";
            baseUrlDeposit = "https://www.bybit.com/user/assets/deposit";
        } else if (cex === "MEXC") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.mexc.com/exchange/${token}_USDT?_from=search`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.mexc.com/exchange/${pair}_USDT?_from=search`;
            baseUrlWithdraw = `https://www.mexc.com/assets/withdraw/${token}`;
            baseUrlDeposit = `https://www.mexc.com/assets/deposit/${pair}`;
        } else if (cex === "OKX") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.okx.com/trade-spot/${token}-usdt`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.okx.com/trade-spot/${pair}-usdt`;
            baseUrlWithdraw = `https://www.okx.com/balance/withdrawal/${token}-chain`;
            baseUrlDeposit = `https://www.okx.com/balance/recharge/${pair}`;
        }
        else if (cex === "BITMART") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bitmart.com/trade/en-US?symbol=${token}_USDT&type=spot`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bitmart.com/trade/en-US?symbol=${pair}_USDT&type=spot`;
            baseUrlWithdraw = `https://www.bitmart.com/asset-withdrawal/en-US`;
            baseUrlDeposit = `https://www.bitmart.com/asset-deposit/en-US`;
        }
        else if (cex === "INDODAX") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://indodax.com/market/${token}IDR`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://indodax.com/market/${pair}IDR`;
            baseUrlWithdraw = `https://indodax.com/finance/${token}#kirim`;
            baseUrlDeposit = `https://indodax.com/finance/${token}`;
        }

        // Kembalikan objek URL
        return {
            tradeToken: baseUrlTradeToken,
            tradePair: baseUrlTradePair,
            withdrawUrl: baseUrlWithdraw,
            depositUrl: baseUrlDeposit
        };
    }

    // Menampilkan form settingan
    $("#SettingModal").on("click", function () {
        UIkit.modal("#modal-setting").show(); // Tampilkan modal
        let appSettings = getFromLocalStorage('DATA_SETTING', {}); // Ambil data setting

        const dexList = DTChain.DEXS || [];

        function loadSettings() {
            // Panggil generateInputModal versi dua modal (kiri & kanan)
            generateInputModal(dexList); // pastikan ini versi dua input

            // Isi nilai modal kiri & kanan
            dexList.forEach((dex) => {
                const dexUpper = dex.toUpperCase();
                const kiri = appSettings[`MODAL_KIRI_${dexUpper}`] || "0";
                const kanan = appSettings[`MODAL_KANAN_${dexUpper}`] || "0";

                $(`#ModalKiri${dexUpper}`).val(kiri);
                $(`#ModalKanan${dexUpper}`).val(kanan);
            });

            // Setting umum lainnya
            $('#user').val(appSettings.nickname || '');
            $('#inFilterPNL').val(appSettings.filterPNL || 0);
            $('#jeda-time-group').val(appSettings.jedaTimeGroup || 400);
            $('#jeda-koin').val(appSettings.jedaKoin || 200);
            $('#walletMeta').val(appSettings.walletMeta || '');
            $('#speedScan').val(appSettings.speedScan || 4);

            $(`input[name="koin-group"][value="${appSettings.scanPerKoin || 10}"]`).prop('checked', true);
            $(`input[name="waktu-tunggu"][value="${appSettings.speedScan || 4}"]`).prop('checked', true);
        }

        loadSettings();
    });

        // SIMPAN SETTING
    $('#save-config').on('click', function () {
        let nickname = $('#user').val();
        let filterPNL = parseFloat($('#inFilterPNL').val());
        let jedaTimeGroup = $('#jeda-time-group').val();
        let jedaKoin = $('#jeda-koin').val();
        let walletMeta = $('#walletMeta').val();

        if (!nickname || !filterPNL || !jedaTimeGroup || !jedaKoin || !walletMeta) {
            alert('SEMUA HARUS DIISI!');
            return;
        }

        let scanPerKoin = $('input[name="koin-group"]:checked').val();
        let speedScan = $('input[name="waktu-tunggu"]:checked').val();

        let dexData = {};
        DTChain.DEXS.forEach(dex => {
            let dexUpper = dex.toUpperCase();
            let modalKiri = $(`#ModalKiri${dexUpper}`).val();
            let modalKanan = $(`#ModalKanan${dexUpper}`).val();

            if (modalKiri !== undefined) {
                dexData[`MODAL_KIRI_${dexUpper}`] = modalKiri;
            }
            if (modalKanan !== undefined) {
                dexData[`MODAL_KANAN_${dexUpper}`] = modalKanan;
            }
        });

        // Ambil data lama
        let oldData = getFromLocalStorage('DATA_SETTING', {});

        // Gabungkan data lama dan baru
        let appSettings = {
            ...oldData,
            ...dexData,
            nickname: nickname,
            filterPNL: filterPNL,
            jedaTimeGroup: jedaTimeGroup,
            jedaKoin: jedaKoin,
            walletMeta: walletMeta,
            scanPerKoin: scanPerKoin,
            speedScan: speedScan
        };

        saveToLocalStorage('DATA_SETTING', appSettings);

        UIkit.modal("#modal-setting").hide();
        alert("SIMPAN SETTING APLIKASI BERHASIL!!");
        location.reload();
    });

   $(document).on('change', '#cex-options input[type="checkbox"], #dex-options input[type="checkbox"], #dexpair-options input[type="checkbox"]', function() {
    const groupName = $(this).closest('div[id^="cex-options"], div[id^="dex-options"], div[id^="dexpair-options"]').attr('id');
    let selectedValues = [];
    $(`#${groupName} input[type="checkbox"]:checked`).each(function() {
        selectedValues.push($(this).val());
    });

    // ❌ Khusus untuk DEX: Batasi max 4
    if (groupName === "dex-options" && selectedValues.length > 4) {
        $(this).prop("checked", false);
        UIkit.notification("❌ MAX 4 DEX, SILAKAN KURANGI!! ❌", { status: 'danger' });
        return;
    }

    // ❌ Cegah kosong: minimal 1 harus terpilih
    if (selectedValues.length === 0) {
        $(this).prop("checked", true); // kembalikan centang
        UIkit.notification("⚠ MINIMAL PILIH 1 DEX!", { status: 'warning' });
        return;
    }

    // Map key localStorage
    const localStorageKeyMap = {
        'cex-options': 'CEX_PILIH',
        'dex-options': 'DEX_PILIH',
        'dexpair-options': 'DEXPAIR_PILIH'
    };
    const localStorageKey = localStorageKeyMap[groupName];

    if (localStorageKey) {
        saveToLocalStorage(localStorageKey, selectedValues);
        UIkit.notification(`SETTING APLIKASI ${groupName.toUpperCase()} menjadi ${selectedValues.join(', ')} !`, { status: 'success' });
    }

    // Filter dan reload data
    const filteredTokens = filterTokens(selectedValues);
    loadStoredData(filteredTokens);
    location.reload();
});


    // Fungsi untuk mengurutkan tabel
    function sortTable(columnIndex) {
        const rows = $('#dataTableBody tr').get();

        rows.sort(function(a, b) {
            const keyA = $(a).children('td').eq(columnIndex).text().toUpperCase();
            const keyB = $(b).children('td').eq(columnIndex).text().toUpperCase();

            if (sortOrder[columnIndex] === undefined) {
                sortOrder[columnIndex] = true; // Default ke urutan naik
            }

            if (keyA < keyB) return sortOrder[columnIndex] ? -1 : 1;
            if (keyA > keyB) return sortOrder[columnIndex] ? 1 : -1;
            return 0;
        });

        // Kosongkan tabel dan tambahkan kembali baris yang sudah diurutkan
        $('#dataTableBody').empty().append(rows);

        // Update kolom No agar tetap berurutan
        $('#dataTableBody tr').each((index, row) => {
            $(row).children('td').first().text(index + 1); // Set nomor berurutan
        });

        // Toggle urutan untuk kolom yang sama
        sortOrder[columnIndex] = !sortOrder[columnIndex];
        updateSortIcons();
    }

    // Memperbarui ikon urutan
    function updateSortIcons() {
        $('.sort-icon').html(''); // Reset semua ikon
        for (let index in sortOrder) {
            const icon = sortOrder[index] ? '▲' : '▼';
            $('#sortIcon' + index).html(icon);
        }
    }

    function generateInputModal(dexList) {
        const container = $('#modal-container');
        container.empty(); // Bersihkan container

        dexList.forEach(dex => {
            const dexUpperCase = dex.toUpperCase();

            // Judul per DEX
            const heading = $('<h5></h5>')
                .css({ 'margin': '8px 0px', 'color': '#e4322c' })
                .text(`Modal ${dexUpperCase}`);
            container.append(heading);

            // Buat wrapper div untuk input kiri dan kanan
            const rowDiv = $('<div></div>').addClass('uk-grid-small').addClass('uk-child-width-1-2').attr('uk-grid', '');

            // Input Modal Kiri
            const leftDiv = $('<div></div>');
            const leftLabel = $('<label></label>').text('Kiri');
            const leftInput = $('<input>')
                .attr('type', 'number')
                .attr('id', `ModalKiri${dexUpperCase}`)
                .addClass('uk-input')
                .val('0')
                .attr('required', true);
            leftDiv.append(leftLabel).append(leftInput);

            // Input Modal Kanan
            const rightDiv = $('<div></div>');
            const rightLabel = $('<label></label>').text('Kanan');
            const rightInput = $('<input>')
                .attr('type', 'number')
                .attr('id', `ModalKanan${dexUpperCase}`)
                .addClass('uk-input')
                .val('0')
                .attr('required', true);
            rightDiv.append(rightLabel).append(rightInput);

            // Gabungkan kiri dan kanan
            rowDiv.append(leftDiv).append(rightDiv);

            // Tambahkan ke container
            container.append(rowDiv);
        });
    }

    // Fungsi untuk memproses data order book exchanger
 
    function processOrderBook(data) {
        const rawBids = Array.isArray(data?.bids) ? data.bids.slice(0, 3) : [];
        const rawAsks = Array.isArray(data?.asks) ? data.asks.slice(0, 3) : [];

        const priceBuy = rawBids.map(([price, volume]) => ({
            price: parseFloat(price),
            volume: parseFloat(volume) * parseFloat(price)
        })).reverse();

        const priceSell = rawAsks.map(([price, volume]) => ({
            price: parseFloat(price),
            volume: parseFloat(volume) * parseFloat(price)
        })).reverse();

        return { priceBuy, priceSell };
    }


    function getRateUSDT() {
        // Ambil harga ETHUSDT dari API Binance
        $.getJSON('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT')
            .done(function (response) {
                let ratePrice = {}; // Inisialisasi objek untuk menyimpan harga
                
                // Simpan harga ETH/USDT ke ratePrice
                if (response.price) {
                    ratePrice["eth"] = parseFloat(response.price); // Harga ETH ke USDT
                }
    
                // Ambil harga USDT/IDR dari API Indodax
                $.getJSON('https://indodax.com/api/ticker/usdtidr')
                    .done(function (responseIndodax) {
                        ratePrice["idr"] = parseFloat(responseIndodax.ticker.last); // Harga USDT ke IDR
    
                        // Hitung harga ETH ke IDR
                        if (ratePrice.eth) {
                            saveToLocalStorage('RateIDRETH', ratePrice.eth);
                            saveToLocalStorage('RateETHIDR', ratePrice.eth);
                         //   console.log("RATE ETH/USDT: " + ratePrice.eth.toFixed(2));
                        }
    
                        // Simpan harga USDT ke IDR ke localStorage dan tampilkan di halaman
                        if (ratePrice.idr) {
                            saveToLocalStorage('PriceRateUSDT', ratePrice.idr);
                            console.log("RATE USDT/IDR: " + ratePrice.idr);
                          // $("#rateUSDT").text("RATE USDT/IDR: " + ratePrice.idr);
                        }
                    })
                    .fail(function (error) {
                        console.error("Error fetching USDT/IDR price:", error);
                        toastr.error('KONEKSI INDODAX KENA lIMIT!');
                    });
            })
            .fail(function (error) {
                console.error("Error fetching ETH/USDT price:", error);
                toastr.error('CEK KONEKSI BINANCE ANDA / AKTIFKAN CORS!');
            });
    }

  
    function updateTableVolCEXBACKUP(processedData, finalResult, cex) {
        const cexName = cex.toUpperCase();
        const TokenPair = finalResult.token + "_" + finalResult.pair;
        const isIndodax = cexName === 'INDODAX';

        const getPriceIDR = priceUSDT => {
            const rateIDR = getFromLocalStorage("PriceRateUSDT", 0);
            return rateIDR ? (priceUSDT * rateIDR).toLocaleString("id-ID", { style: "currency", currency: "IDR" }) : "N/A";
        };

        // LEFT: token → pair
        const volumesBuyToken = isIndodax
            ? finalResult.volumes_buyToken.slice().sort((a, b) => b.price - a.price)
            : finalResult.volumes_buyToken.slice().sort((a, b) => b.price - a.price); // harga besar → kecil

        const volumesSellPair = isIndodax
            ? finalResult.volumes_sellPair
            : finalResult.volumes_sellPair; // harga kecil → besar

        // RIGHT: pair → token
        const volumesBuyPair = isIndodax
            ? finalResult.volumes_buyPair.slice().sort((a, b) => b.price - a.price) // harga besar → kecil
            : finalResult.volumes_buyPair.slice().sort((a, b) => b.price - a.price); 

        const volumesSellToken = isIndodax
            ? finalResult.volumes_sellToken
            : finalResult.volumes_sellToken.slice().sort((a, b) => b.price - a.price); // harga besar → kecil

        $('#LEFT_' + cexName + '_' + TokenPair + '_' + DTChain.Nama_Chain.toUpperCase()).html(
            volumesBuyToken.map(data => `
                <span class='uk-text-success' title="IDR: ${getPriceIDR(data.price)}">
                    ${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/>
                </span>
            `).join('') +
            `<span class='uk-text-primary uk-text-bolder'>${finalResult.token} -> ${finalResult.pair}</span><br/>` +
            volumesSellPair.map(data => `
                <span class='uk-text-danger' title="IDR: ${getPriceIDR(data.price)}">
                    ${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/>
                </span>
            `).join('')
        );

        $('#RIGHT_' + cexName + '_' + TokenPair + '_' + DTChain.Nama_Chain.toUpperCase()).html(
            volumesBuyPair.map(data => `
                <span class='uk-text-success' title="IDR: ${getPriceIDR(data.price)}">
                    ${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/>
                </span>
            `).join('') +
            `<span class='uk-text-primary uk-text-bolder'>${finalResult.pair} -> ${finalResult.token}</span><br/>` +
            volumesSellToken.map(data => `
                <span class='uk-text-danger' title="IDR: ${getPriceIDR(data.price)}">
                    ${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/>
                </span>
            `).join('')
        );
    }
  
    // list api OKXDEX sell_BINANCE_USDT_buy_0x_BAL
    const apiKeysOKXDEX = [
            // {
            // ApiKeyOKX : "a4569d13-8a59-4ecd-9936-6c4e1233bff8",
            // secretKeyOKX : "4484BC9B2FC22C35CB1071A2A520FDC8",
            // PassphraseOKX : "Macpro-2025",
            // },
            //  {
            // ApiKeyOKX : "71cbe094-380a-4146-b619-e81a254c0702",
            // secretKeyOKX : "5116D48C1847EB2D7BDD6DDD1FC8B199",
            // PassphraseOKX : "Macpro-2025"
            // },
            //  {
            // ApiKeyOKX : "81a072cc-b079-410c-9963-fb8e49c16d9d",
            // secretKeyOKX : "BF44AE00CF775DC6DDB0FDADF61EC724",
            // PassphraseOKX : "Macpro-2025"
            // },
            // {
            // ApiKeyOKX : "adad55d1-bf90-43ac-ac03-0a43dc7ccee2",
            // secretKeyOKX : "528AFB3ECC88653A9070F05CC3839611",
            // PassphraseOKX : "Cek_Horeg_911",
            // },
            // {
            // ApiKeyOKX : "6866441f-6510-4175-b032-342ad6798817",
            // secretKeyOKX : "E6E4285106CB101B39FECC385B64CAB1",
            // PassphraseOKX : "Arekpinter123.",
            // }

{
    ApiKeyOKX: "28bc65f0-8cd1-4ecb-9b53-14d84a75814b",
    secretKeyOKX: "E8C92510E44400D8A709FBF140AABEC1",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "04f923ec-98f2-4e60-bed3-b8f2d419c773",
    secretKeyOKX: "3D7D0BD3D985C8147F70592DF6BE3C48",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "cf214e57-8af2-42bf-8afa-3b7880c5a152",
    secretKeyOKX: "26AA1E415682BD8BBDF44A9B1CFF4759",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "a77871bd-7855-484c-a675-e429bad3490e",
    secretKeyOKX: "830C9BB8D963F293857DB0CCA5459089",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "87db4731-fbe3-416f-8bb4-a4f5e5cb64f7",
    secretKeyOKX: "B773838680FF09F2069AEE28337BBCD0",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "aec98aef-e2b6-4fb2-b63b-89e358ba1fe1",
    secretKeyOKX: "DB683C83FF6FB460227ACB57503F9233",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "6636873a-e8ab-4063-a602-7fbeb8d85835",
    secretKeyOKX: "B83EF91AFB861BA3E208F2680FAEDDC3",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "989d75b7-49ff-40a1-9c8a-ba94a5e76793",
    secretKeyOKX: "C30FCABB0B95BE4529D5BA1097954D34",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "43c169db-db8c-4aeb-9c25-a2761fdcae49",
    secretKeyOKX: "7F812C175823BBD9BD5461B0E3A106F5",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "904cefba-08ce-48e9-9e8b-33411bf44a0f",
    secretKeyOKX: "91F2761A0B77B1DEED87A54E75BE1CCE",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "bfbd60b5-9aee-461d-9c17-3b401f9671d1",
    secretKeyOKX: "D621020540042C41D984E2FB78BED5E4",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "86f40277-661c-4290-929b-29a25b851a87",
    secretKeyOKX: "9274F990B5BEDAB5EB0C035188880081",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "32503ada-3d34-411a-b50b-b3e0f36f3b47",
    secretKeyOKX: "196658185E65F93963323870B521A6F6",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "80932e81-45b1-497e-bc14-81bdb6ed38d5",
    secretKeyOKX: "4CA9689FA4DE86F4E4CBF2B777CBAA91",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "a81d5a32-569a-401c-b207-3f0dd8f949c7",
    secretKeyOKX: "307D988DA44D37C911AA8A171B0975DB",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "ca59e403-4bcb-410a-88bb-3e931a2829d5",
    secretKeyOKX: "AC7C6D593C29F3378BF93E7EDF74CB6D",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "97439591-ea8e-4d78-86bb-bdac8e43e835",
    secretKeyOKX: "54970C78369CE892E2D1B8B296B4E572",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "f7a23981-af15-47f4-8775-8200f9fdfe5d",
    secretKeyOKX: "4F61764255CEDE6D5E151714B3E1E93B",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "4f708f99-2e06-4c81-88cb-3c8323fa42c5",
    secretKeyOKX: "A5B7DCA10A874922F54DC2204D6A0435",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "61061ef4-6d0a-412a-92a9-bdc29c6161a7",
    secretKeyOKX: "4DDF73FD7C38EB50CD09BF84CDB418ED",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "b63f3f68-2008-4df5-9d2e-ae888435332b",
    secretKeyOKX: "1427387D7B1A67018AA26D364700527B",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "ecc51700-e7a2-4c93-9c8d-dbc43bda74c1",
    secretKeyOKX: "6A897CF4D6B56AF6B4E39942C8811871",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "dd3f982e-0e20-4ecd-8a03-12d7b0f54586",
    secretKeyOKX: "9F69EEB1A17CCCE9862B797428D56C00",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "a6fd566b-90ed-42c1-8575-1e15c05e395c",
    secretKeyOKX: "77FA24FA1DBFFBA5C9C83367D0EAE676",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "a499fca1-14cd-41c3-a5bc-0eb37581eff9",
    secretKeyOKX: "B8101413760E26278FFAF6F0A2BCEA73",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "c3c7e029-64b7-4704-8fdc-6d1861ad876a",
    secretKeyOKX: "B13A8CFA344038FAACB44A3E92C9C057",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "1974cbac-2a05-4892-88e0-eb262d5d2798",
    secretKeyOKX: "6A24A249F758047057A993D9A460DA7F",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "41826044-b7bb-4465-a903-3da61e336747",
    secretKeyOKX: "F42BD9E95F01BCD248C94EE2EECDE19A",
    PassphraseOKX: "Regi!#007"
},
{
    ApiKeyOKX: "08af14cb-2f97-472c-90cd-fefd2103f253",
    secretKeyOKX: "FFC78575E3961D11BF134C8DE9CBE7F8",
    PassphraseOKX: "Regi!#007"
},    
      ];
      
       // Fungsi untuk Signature
    function calculateSignature(exchange, apiSecret, dataToSign, hashMethod = "HmacSHA256") {
        if (!apiSecret || !dataToSign) {
            console.error(`[${exchange}] API Secret atau Data untuk Signature tidak valid!`);
            return null;
        }
    
        switch (exchange.toUpperCase()) {
            case "MEXC":
            case "BINANCE":
            case "KUCOIN":
            case "BYBIT":
                // Gunakan HMAC-SHA256
                return CryptoJS[hashMethod](dataToSign, apiSecret).toString(CryptoJS.enc.Hex);
    
            case "OKX":
                // Gunakan BASE64 untuk OKX
                const hmac = CryptoJS.HmacSHA256(dataToSign, apiSecret);
                return CryptoJS.enc.Base64.stringify(hmac);
    
            default:
                console.error(`[${exchange}] Exchange tidak didukung untuk perhitungan signature.`);
                return null;
        }
    } 
    
      // Fungsi untuk mendapatkan kredensial API secara acak
      function getRandomApiKeyOKX() {
        const randomIndex = Math.floor(Math.random() * apiKeysOKXDEX.length);
        return apiKeysOKXDEX[randomIndex];
      }

    function DisplayPNL(PNL, cex, Coin_in, NameX, totalFee, modal, dex, priceCEX, priceDEX, FeeSwap, FeeWD, sc_input, sc_output, Coin_out, totalValue, totalModal, conclusion, selisih, trx, profitLossPercent, vol) {
        var filterPNLValue = parseFloat(SavedSettingData.filterPNL);
        var nickname = SavedSettingData.nickname;
        var totalValue = parseFloat(totalValue);
        var totalGet = totalValue - parseFloat(modal);
        var totalModal = parseFloat(totalModal);
        var totalFee = parseFloat(totalFee);
        var checkVol = $('#checkVOL').is(':checked');

        const urlsCEXToken = GeturlExchanger(cex.toUpperCase(), Coin_in, Coin_out);
        var buyLink = urlsCEXToken.tradeToken;
        var sellLink = urlsCEXToken.tradePair;
        var IdCELL = `${cex.toUpperCase()}_${dex.toUpperCase()}_${NameX}_${(DTChain.Nama_Chain).toUpperCase()}`;
        var rowCell = $(`#${IdCELL}`);
        var resultCell = $(`#RESULT_${IdCELL}`);
        var buyCell = $(`#LEFT_${IdCELL}`);
        var sellCell = $(`#RIGHT_${IdCELL}`);

        var sinyals = `<a href="#SWAP_${cex.toUpperCase()}_${dex.toUpperCase()}_${NameX}_${(DTChain.Nama_Chain).toUpperCase()}" class='link-class'>
            ${cex.toUpperCase()} VS ${dex.toUpperCase()} : ${NameX} (${PNL.toFixed(2)}$)</a>`;

        const isLolosFilter = (totalValue - totalModal) >= filterPNLValue;
        const isUntungBersih = PNL > 0;
        const isVolEnough = parseFloat(vol) >= parseFloat(modal);
        const lolosHighlight = isLolosFilter && (!checkVol || (checkVol && isVolEnough));

        // --- HTML Fee & PNL selalu dibuat ---
        let htmlFee = '';
        if (trx === "TokentoPair") {
            htmlFee = `<span style="color:#0f04e2 !important;">FeeWD: ${FeeWD.toFixed(2)}$</span> | ${createLink(urlsCEXToken.withdrawUrl, 'WD')}<br/>`;
        } else if (trx === "PairtoToken") {
            htmlFee = `<span style="color:#0f04e2 !important;">FeeWD: ${FeeWD.toFixed(2)}$</span> | ${createLink(urlsCEXToken.depositUrl, 'DP')}<br/>`;
        }

        let htmlResult = `
            ${htmlFee}
            <span style="color: #d20000;">All: ${totalFee.toFixed(2)}$</span>
            <span style="color: #1e87f0;">SW: ${FeeSwap.toFixed(2)}$</span><br/>
            <span style="color: #444;">GT: ${totalGet.toFixed(2)}$</span>
            <span style="color: #444;">PNL: ${PNL.toFixed(2)}$</span><br/>
        `;
        resultCell.html(htmlResult);

        // --- Highlight & sinyal ---
        // Highlight utama
        if (lolosHighlight || isUntungBersih) {
            toastr.success(sinyals);
            rowCell.css({
                "background-color": "#daf4c3",
                "font-weight": "bolder",
                "color": "black"
            });
            InfoSinyal(dex.toLowerCase(), NameX, PNL, totalFee, cex.toUpperCase(), Coin_in, Coin_out, profitLossPercent, modal, trx);
        }

        // Link buy/sell (pasang jika belum ada)
        if (!buyCell.parent().is("span")) {
            buyCell.wrap('<a href="' + buyLink + '" target="_blank"></a>');
        }
        if (!sellCell.parent().is("span")) {
            sellCell.wrap('<a href="' + sellLink + '" target="_blank"></a>');
        }

        // Highlight kondisi rugi/cuan besar
        if (PNL < (-0.5 * parseFloat(modal))) {
            rowCell.attr("style", "background-color: #ffe0e6 !important; font-weight: bold !important; color: black !important;");
        }
        if (PNL > (0.5 * parseFloat(modal))) {
            rowCell.attr("style", "background-color: #ffd9b2 !important; font-weight: bold !important; color: black !important;");
        }

        // Kirim pesan multi-send kalau PNL besar
        if (PNL > 1 && parseFloat(vol) >= parseFloat(modal)) {
            MultisendMessage(cex, dex.toUpperCase(), Coin_in, Coin_out, modal, PNL, priceCEX, priceDEX, FeeSwap, FeeWD, totalFee, nickname, sc_input, sc_output);
        }
    }

    // Fungsi untuk menampilkan sinyal hasil scan dan memutar suara
    function InfoSinyal(DEXPLUS, TokenPair, PNL, totalFee, cex, NameToken, NamePair, profitLossPercent, modal, trx) {
        var filterPNLValue = parseFloat(SavedSettingData.filterPNL);
        var warnaCEX = getWarnaCEX(cex);
        let idCELL = `${cex.toUpperCase()}_${DEXPLUS.toUpperCase()}_${NameToken}_${NamePair}_${(DTChain.Nama_Chain).toUpperCase()}`;

        let warnaPNL = trx === "TokentoPair" ? "uk-text-success" : "uk-text-danger";

        // Default style
        let highlightStyle = "";
        if (PNL > filterPNLValue) {
            highlightStyle = "background-color:#daf4c2; font-weight:bolder;";
        }

       var sLink = `<a href="#${idCELL}" class="buy">
            <span style="color:${warnaCEX}; display:inline-block; ${highlightStyle}; margin-right:7px;">
                [ ${cex.toUpperCase()}
                <span class="${warnaPNL}"> ~ ${NameToken}->${NamePair}</span>: <span style="color:black;">${PNL.toFixed(2)}$</span> ]
            </span>
        </a>`;


        $("#sinyal" + DEXPLUS.toLowerCase()).append(` ${sLink} `);

        var audio = new Audio('audio.mp3');
        audio.play();
    }

   // ALL Sent TELE
    function sendStatusTELE(user, status) {
        var users = [
            { chat_id: SavedSettingData.ID_GRUP }
        ];

        var token = SavedSettingData.TOKEN;
        var apiUrl = 'https://api.telegram.org/bot' + token + '/sendMessage';

        // Ambil data dari localStorage dan parse sebagai JSON object
        var data = getFromLocalStorage('ID','');
        var pilihDex = getFromLocalStorage('DEX_PILIH', null);
        var pilihCex = getFromLocalStorage('CEX_PILIH', null);
        var dexList = pilihDex ? pilihDex.join(', ') : 'Not Selected';
        var cexList = pilihCex ? pilihCex.join(', ') : 'Not Selected';

        var message = " #" + user.toUpperCase() + " is <b>[ " + status + " ]</b>" +
            "\n ----------------------------------------------------"+
            "\n <b> MONITORING_V1 ~ "+DTChain.Nama_Chain.toUpperCase()+" </b>"+
            "\n <b> CEX: </b>" + cexList.toUpperCase() +
            "\n <b> DEX: </b>" + dexList.toUpperCase() +
            "\n <b> ID UNIX : </b>" + data.id +
            "\n <b> PROVIDER : </b> " + data.name +
            "\n <b> IP : </b>" + data.ip+
            "\n ----------------------------------------------------";
        // Loop melalui daftar pengguna
        for (var i = 0; i < users.length; i++) {
            var user = users[i];
            var chatId = user.chat_id; // Ganti dengan ID chat pengguna

            // Membuat permintaan POST menggunakan jQuery
            $.ajax({
            url: apiUrl,
            method: "POST",
            data: {
                chat_id: chatId,
                text: message,
                parse_mode: "HTML",
                disable_web_page_preview: true
            },
            success: function(response) {
                // console.log("Message sent successfully");
            },
            error: function(xhr, status, error) {
                console.log("Error sending message:", error);
            }
            });
          }
        }
        //sent sinyal kegrup tele
        function MultisendMessage(cex, dex, token, pair, modal, PNL, priceBUY, priceSELL, FeeSwap, FeeWD, totalFee, nickname, sc_in, sc_out) {
            const urlsCEX = GeturlExchanger(cex, token, pair);
            const SavedSettingData = getFromLocalStorage('DATA_SETTING', { ID_GRUP: 0, TOKEN: '' });

            if (!SavedSettingData.TOKEN || !SavedSettingData.ID_GRUP) {
                toastr.error("Token atau ID Grup Telegram tidak tersedia!");
                return;
            }

            let Linksctoken = `<a href="${DTChain.URL_Chain}/token/${sc_in}" target="_blank" class="uk-link">${token}</a>`;
            let Linkscpair = `<a href="${DTChain.URL_Chain}/token/${sc_out}" target="_blank" class="uk-link">${pair}</a>`;
            let linkDEX = `<a href="https://swap.defillama.com/?chain=${DTChain.Nama_Chain}&from=${sc_in}&to=${sc_out}" target="_blank" class="uk-link">${dex}</a>`;
            let linkCEX = urlsCEX && urlsCEX.tradeToken ? `<a href="${urlsCEX.tradeToken}" target="_blank" class="uk-link">${cex}</a>` : `<b>${cex}</b>`;

            let message = 
                `<b>#MONITORING_V1 #${DTChain.Nama_Chain.toUpperCase()}</b>\nUSER: ~ ${nickname}\n` +
                `-----------------------------------------\n` +
                `MARKET: ${linkCEX} VS ${linkDEX}\n` +
                `TOKEN-PAIR: <b>#${token}_${pair}</b>\n` +
                `MODAL: <b>${modal}$</b> | PROFIT: <b>${PNL.toFixed(2)}$</b>\n` +
                `<b>BUY ${Linksctoken}:</b> ${priceBUY.toFixed(9)}\n` +
                `<b>SELL ${Linkscpair}:</b> ${priceSELL.toFixed(9)}\n` +
                `<b>FEEWD:</b> ${FeeWD.toFixed(3)}\n` +
                `FEETOTAL: <b>${totalFee.toFixed(2)}$</b> | SWAP: <b>${FeeSwap.toFixed(2)}$</b>\n` +
                `-----------------------------------------`;

           // toastr.info(message);

            // Kirim ke Telegram
            const apiUrl = 'https://api.telegram.org/bot' + SavedSettingData.TOKEN + '/sendMessage';
            $.ajax({
                url: apiUrl,
                method: "POST",
                data: {
                    chat_id: SavedSettingData.ID_GRUP,
                    text: message,
                    parse_mode: "HTML",
                    disable_web_page_preview: true
                },
                success: function () {
                    console.log("Pesan berhasil dikirim ke Telegram");
                },
                error: function (xhr, status, error) {
                    console.error("Gagal kirim pesan:", error);
                    toastr.error("Gagal kirim ke Telegram: " + error);
                }
            });
        }

  
    // Fungsi CekIdentitas untuk mendapatkan ID perangkat
    async function CekIdentitas() {
        try {
            let deviceID = generateDeviceID();
            let response = await fetch('https://api4.my-ip.io/v2/ip.json');
            let data = await response.json();

            let simplifiedIdentitas = {
                id: deviceID,
                name: data.asn.name,
                ip: data.ip
            };

            saveToLocalStorage('ID', simplifiedIdentitas);
            let savedID = getFromLocalStorage('ID', {});
        } catch (error) {
            //toastr.info("GAGAL CEK IP!!");
        }
    }

    // Fungsi generateDeviceID
    function generateDeviceID() {
        let userAgent = navigator.userAgent;
        let screenResolution = `${window.screen.width}x${window.screen.height}`;
        let timezoneOffset = new Date().getTimezoneOffset();
        let language = navigator.language;

        return hashCode(`${userAgent}${screenResolution}${timezoneOffset}${language}`);
    }

    // Fungsi untuk menghasilkan hashCode
    function hashCode(str) {
        return str.split("").reduce((hash, char) => {
            hash = ((hash << 5) - hash) + char.charCodeAt(0);
            return hash & hash;
        }, 0);
    }

    $('#UpdateWalletCEX').on('click', function () {
        // Ambil daftar CEX yang dipilih dari localStorage
        const selectedCEX = getFromLocalStorage("selectedCEX", []); // Ambil data terpilih, default array kosong jika tidak ada
        if (selectedCEX.length === 0) {
            toastr.error("Tidak ada CEX yang dipilih. Silakan pilih CEX terlebih dahulu.");
            return;
        }

        console.log("CEX yang dipilih:");
        selectedCEX.forEach(exchange => {
            console.log(`- ${exchange}`);
        });

        allFeeWD = [];
        isGateSuccess = false;
        isBinanceSuccess = false;
        isKucoinSuccess = false;
        isBitgetSuccess = false;
        isBybitSuccess = false;
        isMexcSuccess = false;
        isOkxSuccess = false;
        isINDODAXSuccess = false;
        isBitmartSuccess = false;

        // Cek dan panggil fungsi cek fee withdrawal hanya untuk CEX yang dipilih
        selectedCEX.forEach(exchange => {
            if (CONFIG_CEX[exchange]) {
                console.log(`Memeriksa Status Wallet ${exchange.toUpperCase()}...`);
                switch (exchange) {
                    case "GATE":
                        CekfeeWDGATE(CONFIG_CEX.GATE);
                        break;
                    case "BINANCE":
                        CekfeeWDBINANCE(CONFIG_CEX.BINANCE);
                        break;
                    
                    case "MEXC":
                        CekfeeWDMEXC(CONFIG_CEX.MEXC);
                        break;
                    
                    case "INDODAX":
                        CekfeeWDINDODAX();
                        break;
                    default:
                        console.warn(`CEX ${exchange} tidak dikenali.`);
                }
            }
        });
    });

    // Fungsi untuk mengecek apakah semua pembaruan berhasil
    function checkAllUpdatesCompleted() {
        let allSuccess = true;
        let isSuccess = 0;

        if (CONFIG_CEX.GATE && isGateSuccess !== true) allSuccess = false; else isSuccess++;
        if (CONFIG_CEX.BINANCE && isBinanceSuccess !== true) allSuccess = false; else isSuccess++;
        if (CONFIG_CEX.MEXC && isMexcSuccess !== true) allSuccess = false; else isSuccess++;
        if (isINDODAXSuccess !== true) allSuccess = false; else isSuccess++;

        const selectedCEX = getFromLocalStorage("selectedCEX", []);
        const lastModifiedTime = new Date().toLocaleString();
        const totalWallets = allFeeWD.length;

        if (totalWallets >= 0 && isSuccess === selectedCEX.length) {
            removeFromLocalStorage("WALLET_CEX");
            removeFromLocalStorage("LASTUPDATE_FEEWD");

            saveToLocalStorage("WALLET_CEX", allFeeWD);
            saveToLocalStorage("LASTUPDATE_FEEWD", lastModifiedTime);

            const storedScanner = getFromLocalStorage("MULTI_SCANNER", []);
            const storedFav = getFromLocalStorage("TOKEN_SCANNER", []);
            const WalletCEXData = getFromLocalStorage("WALLET_CEX", []);

            // Fungsi umum untuk merge data token dengan status wallet
            function mergeTokenData(tokenList) {
                return tokenList.map(token => {
                    const walletToken = WalletCEXData.find(item =>
                        item.cex === token.cex && item.tokenName === token.symbol_in
                    );
                    const walletPair = WalletCEXData.find(item =>
                        item.cex === token.cex && item.tokenName === token.symbol_out
                    );

                    return {
                        ...token,
                        feeWDToken: walletToken ? parseFloat(walletToken.feeWDs) : "",
                        feeWDPair: walletPair ? parseFloat(walletPair.feeWDs) : "",
                        depositPair: walletPair ? Boolean(walletPair.depositEnable) : false,
                        withdrawPair: walletPair ? Boolean(walletPair.withdrawEnable) : false,
                        depositToken: walletToken ? Boolean(walletToken.depositEnable) : false,
                        withdrawToken: walletToken ? Boolean(walletToken.withdrawEnable) : false
                    };
                });
            }

            const updatedScanner = mergeTokenData(storedScanner);
            const updatedFav = mergeTokenData(storedFav);

            if (confirm('RELOAD STATUS WITHDRAW & DEPOSIT CEX?')) {
                saveToLocalStorage("MULTI_SCANNER", updatedScanner);
                saveToLocalStorage("TOKEN_SCANNER", updatedFav);

                const savedScanner = getFromLocalStorage("MULTI_SCANNER", []);
                const savedFav = getFromLocalStorage("TOKEN_SCANNER", []);

                const scannerOK = savedScanner.length === updatedScanner.length;
                const favOK = savedFav.length === updatedFav.length;

                if (scannerOK && favOK) {
                    alert("✅ SUKSES UPDATE WALLET CEX (GLOBAL & FAVORITE)");
                    setLastAction("UPDATE WALLET CEX");
                    location.reload();
                } else {
                    toastr.error("❌ GAGAL UPDATE TOKEN GLOBAL ATAU FAVORITE!", {
                        timeOut: 5000,
                        progressBar: true,
                        closeButton: true,
                    });
                    setLastAction("GAGAL UPDATE WALLET");
                }
            }
        }
    }
   
    // Fungsi untuk Signature CEX
    function calculateSignature(exchange, apiSecret, dataToSign, hashMethod = "HmacSHA256") {
        if (!apiSecret || !dataToSign) {
            console.error(`[${exchange}] API Secret atau Data untuk Signature tidak valid!`);
            return null;
        }
    
        switch (exchange.toUpperCase()) {
            case "MEXC":
            case "BINANCE":
            case "KUCOIN":
            case "BYBIT":
                // Gunakan HMAC-SHA256
                return CryptoJS[hashMethod](dataToSign, apiSecret).toString(CryptoJS.enc.Hex);
    
            case "OKX":
                // Gunakan BASE64 untuk OKX
                const hmac = CryptoJS.HmacSHA256(dataToSign, apiSecret);
                return CryptoJS.enc.Base64.stringify(hmac);
    
            default:
                console.error(`[${exchange}] Exchange tidak didukung untuk perhitungan signature.`);
                return null;
        }
    }    

    function CekfeeWDINDODAX() {
        // Ambil data token dari localStorage
        const TokenDataIndodax = getFromLocalStorage("TOKEN");

        // Cek jika data tersedia dan merupakan array
        if (!Array.isArray(TokenDataIndodax)) {
            toastr.error("Data token INDODAX tidak valid atau tidak ditemukan.");
            return;
        }

        // Format jadi dua arah: symbol_in & symbol_out
        const formattedData = TokenDataIndodax
            .filter(token => token.cex === "INDODAX" && token.status === true )
            .flatMap(token => {
                return [
                    {
                        cex: "INDODAX",
                     //   chain: DTChain.CEXCHAIN.INDODAX.chainCEX, // asumsi chain disamakan dengan symbol_out
                        tokenName: token.symbol_in.toUpperCase(),
                        scToken: token.sc_in || "",
                        feeWDs: 0.0001,
                        depositEnable: true,
                        withdrawEnable: true
                    },
                    {
                        cex: "INDODAX",
                    //    chain:  DTChain.CEXCHAIN.INDODAX.chainCEX,
                        tokenName: token.symbol_out.toUpperCase(),
                        scToken: token.sc_out || "",
                        feeWDs: 0.0001,
                        depositEnable: true,
                        withdrawEnable: true
                    }
                ];
            });

        // Tambahkan ke array global
        allFeeWD = allFeeWD.concat(formattedData);
       console.log("INDODAX WALLET:", formattedData);     
        // Tandai sukses dan panggil callback
        toastr.info("SUKSES, CEK UPDATE WALLET INDODAX");
        isINDODAXSuccess = true;
        checkAllUpdatesCompleted();
    }

    function CekfeeWDGATE() {
        var key = CONFIG_CEX.GATE.ApiKey;
        var secret = CONFIG_CEX.GATE.ApiSecret;
        var host = "https://cors-anywhere.herokuapp.com/https://api.gateio.ws";
        var prefix = "/api/v4";
        var method = "GET";
        var chain = DTChain.CEXCHAIN.GATE.chainCEX;
        var timestamp = Math.floor(Date.now() / 1000);

        var buildSignature = function (url, body) {
            var bodyHash = CryptoJS.SHA512(body).toString(CryptoJS.enc.Hex);
            var signString = method + "\n" + prefix + url + "\n" + "" + "\n" + bodyHash + "\n" + timestamp;
            var hmac = CryptoJS.HmacSHA512(signString, secret);
            return hmac.toString(CryptoJS.enc.Hex);
        };

        var feeWDUrl = "/wallet/withdraw_status";
        var feeWDHeaders = {
            'Timestamp': timestamp,
            'KEY': key,
            'SIGN': buildSignature(feeWDUrl, "")
        };

        var statusUrl = "/spot/currencies";
        var statusHeaders = {
            'Timestamp': timestamp,
            'KEY': key,
            'SIGN': buildSignature(statusUrl, "")
        };

        $.when(
            $.ajax({
                url: host + prefix + feeWDUrl,
                method: method,
                headers: feeWDHeaders
            }),
            $.ajax({
                url: host + prefix + statusUrl,
                method: method,
                headers: statusHeaders
            })
        ).done(function (feeWDResponse, statusResponse) {
            var feeWDData = feeWDResponse[0];
            var statusData = statusResponse[0];

            if (!Array.isArray(feeWDData) || !Array.isArray(statusData)) {
                console.error("Unexpected API response");
                toastr.error("Respons API tidak sesuai format!");
                return;
            }

            var combinedData = statusData
                .filter(function (statusItem) {
                    return (
                        statusItem.currency &&
                        !statusItem.currency.includes("_OLD") &&
                        !statusItem.delisted &&
                        Array.isArray(statusItem.chains) &&
                        statusItem.chains.some(function (c) {
                            return c.name === chain;
                        })
                    );
                })
                .map(function (statusItem) {
                    var matchedChain = statusItem.chains.find(function (c) {
                        return c.name === chain;
                    });

                    var feeWDItem = feeWDData.find(function (feeItem) {
                        var cleanStatusCurrency = statusItem.currency.replace(`-${chain}`, "");
                        return (
                            feeItem.currency === cleanStatusCurrency &&
                            feeItem.withdraw_fix_on_chains &&
                            feeItem.withdraw_fix_on_chains[chain]
                        );
                    });

                    var feeWD = feeWDItem ? parseFloat(feeWDItem.withdraw_fix_on_chains[chain]) : null;

                    return {
                        cex: "GATE",
                        chain: matchedChain ? matchedChain.name : "---",
                        tokenName: statusItem.currency.replace(`-${chain}`, "") || "---",
                        scToken: "---",
                        depositEnable: matchedChain ? !matchedChain.deposit_disabled : false,
                        withdrawEnable: matchedChain ? !matchedChain.withdraw_disabled : false,
                        feeWDs: feeWD
                    };
                });

            combinedData = combinedData.filter(function (item) {
                return item.chain && item.tokenName;
            });

            console.log("GATE WALLET:", combinedData);
            allFeeWD = allFeeWD.concat(combinedData);

            toastr.info("SUKSES, CEK UPDATE WALLET GATE");
            isGateSuccess = true;
            checkAllUpdatesCompleted();
        }).fail(function (xhr, status, error) {
            console.error("Error:", error);
            toastr.error("Gagal mendapatkan data dari API GATE");
        });
    }
     
    function CekfeeWDBINANCE() {
        const ApiKey = CONFIG_CEX.BINANCE.ApiKey;
        const ApiSecret = CONFIG_CEX.BINANCE.ApiSecret;
    
        const timestamp = Date.now().toString();
        const recvWindow = CONFIG_CEX.BINANCE.recvWindow || "5000";
        const queryString = `timestamp=${timestamp}`;
        const signature = calculateSignature("BINANCE", ApiSecret, queryString, "HmacSHA256");
    
        if (!signature) {
            toastr.error("Gagal menghitung signature Binance. Periksa konfigurasi.");
            return;
        }
    
        const apiUrl = "https://api.binance.me/sapi/v1/capital/config/getall";
    
        $.ajax({
            url: `${apiUrl}?timestamp=${timestamp}&signature=${signature}`,
            method: "GET",
            headers: {
                "X-MBX-ApiKey": ApiKey,
            },
            success: function (data) {
                console.log(data);
                // Filter berdasarkan network yang sesuai dengan DTChain.CEXCHAIN.BINANCE.chainCEX dan status trading yang true
                const coinsWithNetworkAndTradingTrue = data.filter(function (item) {
                    return item.trading === true && item.networkList.some(function (network) {
                        return network.network === DTChain.CEXCHAIN.BINANCE.chainCEX;
                    });
                });
    
                // Ambil hanya koin beserta status deposit dan withdraw untuk jaringan yang sesuai
                const coinDepositWithdrawStatus = coinsWithNetworkAndTradingTrue.map(function (item) {
                    const Network = item.networkList.find(function (network) {
                        return network.network === DTChain.CEXCHAIN.BINANCE.chainCEX;
                    });
    
                    // Memastikan depositEnable atau withdrawEnable adalah true
                    const depositEnable = Network ? Network.depositEnable === true : false;
                    const withdrawEnable = Network ? Network.withdrawEnable === true : false;
    
                    // Hanya ambil token yang salah satunya memiliki status true
                    if (depositEnable || withdrawEnable) {
                        return {
                            cex: "BINANCE",
                            chain: DTChain.CEXCHAIN.BINANCE.chainCEX,
                            tokenName: item.coin,
                            scToken: Network.contractAddress,
                            feeWDs: Network ? Network.withdrawFee : 0,
                            depositEnable: depositEnable,
                            withdrawEnable: withdrawEnable
                        };
                    }
                    return null; // Token ini diabaikan jika kedua status adalah false
                }).filter(item => item !== null); // Hapus nilai null (yang tidak memenuhi syarat)                
               
                console.log("BINANCE WALLET:",coinDepositWithdrawStatus);
                // Gabungkan hasil ke allFeeWD
                allFeeWD = allFeeWD.concat(coinDepositWithdrawStatus);
                //checkAndSaveAllFeeWD();
    
                toastr.info("SUKSES, CEK UPDATE WALLET BINANCE");
    
                isBinanceSuccess = true; // Tandai sukses
                checkAllUpdatesCompleted();
            },
            error: function () {
                toastr.error('UPDATE FEE WD BINANCE GAGAL, SILAKAN REFRESH!!');
            }
        });
    }    
    // fungsi mengecek status DEPO & WD MEXC
    function CekfeeWDMEXC() {
        const ApiKey = CONFIG_CEX.MEXC.ApiKey; // Ambil API Key dari konfigurasi
        const chainTypeConfig = DTChain.CEXCHAIN.MEXC.chainCEX; // Ambil nilai chainType dari konfigurasi
        const apiSecret = CONFIG_CEX.MEXC.ApiSecret;
        const timestamp = Date.now().toString();
        const recvWindow = "5000";
        const queryString = `recvWindow=${recvWindow}&timestamp=${timestamp}`;
        const signature = calculateSignature("MEXC", apiSecret, queryString);
        if (!signature) {
            toastr.error("Gagal menghitung signature MEXC. Periksa konfigurasi.");
            return;
        }

        const apiUrl = `https://cors-anywhere.herokuapp.com/https://api.mexc.com/api/v3/capital/config/getall`;
        
        $.ajax({
            url: `${apiUrl}?${queryString}&signature=${signature}`,
            method: "GET",
            headers: {
                "X-MEXC-APIKEY": ApiKey,
            },
            success: function (data) {
                // Filter koin berdasarkan konfigurasi chainType
                const coinsWithNetwork = data.filter(item => 
                    item.networkList.some(network => network.netWork === chainTypeConfig)
                );
    
                // Mapping koin yang ditemukan untuk mendapatkan informasi fee dan sc
                const coinDepositWithdrawStatus = coinsWithNetwork.map(item => {
                    const selectedNetwork = item.networkList.find(network => network.netWork === chainTypeConfig);
    
                    return {
                        cex: "MEXC",
                        chain: DTChain.CEXCHAIN.MEXC.chainCEX,
                        tokenName: item.coin,
                        scToken: selectedNetwork ? selectedNetwork.contract : "---",  // Ambil contract address jika ada
                        feeWDs: selectedNetwork ? parseFloat(selectedNetwork.withdrawFee) : 0,
                        depositEnable: selectedNetwork ? selectedNetwork.depositEnable : false,
                        withdrawEnable: selectedNetwork ? selectedNetwork.withdrawEnable : false
                    };
                }).filter(item => item.depositEnable || item.withdrawEnable); // Hanya ambil yang salah satu deposit / withdraw aktif
    
                // Gabungkan hasil ke allFeeWD
                console.log("MEXC WALLET:",coinDepositWithdrawStatus);
                allFeeWD = [...allFeeWD, ...coinDepositWithdrawStatus];
                //checkAndSaveAllFeeWD();
    
                isMexcSuccess = true; // Tandai sukses
                toastr.info("SUKSES, CEK UPDATE WALLET MEXC");
                checkAllUpdatesCompleted();
            },
            error: function (xhr, status, error) {
                toastr.error('UPDATE WALLET MEXC GAGAL, MASALAH KONEKSI!!');
            }
        });
    }
    
    //fungsi download token
    $('#tokenCountALL').on('click', function () {
        // Ambil data dari localStorage
        const rawData = getFromLocalStorage("TOKEN_SCANNER", []);
        //const rawData = filteredData;
        if (!rawData || rawData.length === 0) {
            toastr.error('Data TOKEN tidak ditemukan...');
            return;
        }

        // Proses data ke format CSV
        const formattedData = rawData.map(item => ({
            cex: item.cex,
            symbol_in: item.symbol_in,
            sc_in: item.sc_in,
            des_in: item.des_in,
            withdrawToken: item.status ? "TRUE" : "FALSE",
            depositToken: item.status ? "TRUE" : "FALSE",
            symbol_out: item.symbol_out,
            sc_out: item.sc_out,
            des_out: item.des_out,
            withdrawPair: item.status ? "TRUE" : "FALSE",
            depositPair: item.status ? "TRUE" : "FALSE",
            status: item.status ? "TRUE" : "FALSE" ,
        }));

        // Buat header dan isi CSV
        const csvHeader = Object.keys(formattedData[0]).join(','); // Header CSV
        const csvRows = formattedData.map(row => Object.values(row).join(',')).join('\n'); // Gabungkan semua baris
        const csvContent = `${csvHeader}\n${csvRows}`; // Gabungkan header dan isi

        // Buat file Blob untuk diunduh
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        // Buat elemen <a> untuk download
        const a = document.createElement('a');
        // Hitung jumlah item yang statusnya true
        const countTrueStatus = rawData.filter(item => 
                item.status === true  
        ).length;
   
        a.href = url;
        a.download = countTrueStatus+'_MONITORING_V1_' + (Nama_Chain || 'UNKNOWN').toUpperCase() + '_TOKEN.csv'; // Pastikan Nama_Chain terdefinisi
        a.style.display = 'none';

        // Tambahkan tombol ke DOM dan klik
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });

    function setLastAction(action) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const month = (now.getMonth() + 1).toString().padStart(2, '0'); // Bulan dimulai dari 0
        const year = now.getFullYear();

        const formattedTime = `${hours}:${minutes}:${seconds} | ${day}/${month}/${year}`;

        const lastAction = {
            time: formattedTime,
            action: action
        };

        saveToLocalStorage("HISTORY", lastAction);
        $("#infoAPP").html(`${lastAction.action} at ${lastAction.time}`);
    }
    
</script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.6.22/dist/js/uikit.min.js"></script>
<span id="scrollTopBtn"
      title="Kembali ke Atas"
      style="position:fixed; bottom:20px; right:30px;
             width:25px; height:25px; border-radius:50%;
             background:#07d94d; color:#fff; font-size:20px;
             display:none; z-index:9999; cursor:pointer;
             display:flex; align-items:center; justify-content:center;">
  ↑
</span>

</body>
</html>
